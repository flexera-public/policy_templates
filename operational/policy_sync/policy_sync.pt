name "Policy Template Synchronization Policy Template"
rs_pt_ver 20180301
type "policy"
short_description "A policy to manage policy template. See the [README](https://github.com/rightscale/policy_templates/tree/master/security/security_groups/high_open_ports) and [docs.rightscale.com/policies](http://docs.rightscale.com/policies/) to learn more."
long_description "Version: 1.0"
severity "low"
category "operational"

parameter "escalate_to" do
  type "list"
  label "Email addresses of the recipients you wish to notify"
  default ["rshade@rightscale.com"]
end

auth "auth_rs", type: "rightscale"

datasource "ds_active_policy_list" do
  request do
    verb "GET"
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/PSASSET-867/active-policy-list.json"
    header "User-Agent", "RS Policies"
  end
  result do
    collect jmes_path(response,"policies") do
      field "name", jmes_path(col_item, "name")
      field "file_name", jmes_path(col_item, "file_name")
      field "version", jmes_path(col_item, "version")
    end
  end
end

datasource "ds_current_policy_template_list" do
  request do
    auth $auth_rs
    verb "GET"
    host "governance-3.rightscale.com"
    path join(["/api/governance/projects/",rs_project_id,"/policy_templates"])
    header "Api-Version", "1.0"
    query "view", "extended"
  end
  result do
    collect jmes_path(response,"items") do
      field "name", jmes_path(col_item, "name")
      field "long_description", jmes_path(col_item, "long_description")
    end
  end
end

datasource "ds_combined_policy_list" do
  run_script $js_combine_policy_lists, $ds_active_policy_list, $ds_current_policy_template_list
end

script "js_combine_policy_lists", type: "javascript" do
  parameters "active_policy_list", "current_policy_list"
  result "policy_list"
  code <<-EOS
  var policy_list = [];
  var old_policy_list = {};
  for (var index = 0; index < current_policy_list.length; index++) {
    var current_policy = current_policy_list[index];
    old_policy_list[current_policy.name] = current_policy;
  }

  for ( var i = 0; i < active_policy_list.length; i++) {
    var active_policy = active_policy_list[i]
    var account_policy_template = old_policy_list[active_policy.name]
    if (account_policy_template){
      var account_version = account_policy_template.long_description
      if ( account_version.search(/Version/i) != -1 ) {
        var version_str = account_version.split(' ')
        var account_version = version_str[version_str.length -1]        
      } else {
        var account_version = "0.0"
      }
    } else {
      var account_version = "0.0"
    }
    var a_version = parseFloat(account_version)
    var r_version = parseFloat(active_policy.version)
    if (r_version > a_version) {
      var version_upgradeable = true
    } else {
      var version_upgradeable = false
    }
    policy_list.push({
      name: active_policy.name,
      file_name: active_policy.file_name,
      repo_version: active_policy.version,
      account_version: account_version,
      account_policy_template: account_policy_template,
      version_upgradeable: version_upgradeable
    })
  }
EOS
end

escalation "upload" do
  run "upload_template", data, rs_project_id
end

escalation "alert" do
  email $escalate_to
end

define upload_template($data,$project_id) do
  foreach $item in $data do
    $policy_request = http_get(url: join(["https://raw.githubusercontent.com/rightscale/policy_templates/PSASSET-867/",$item["name"]]))
    $policy_source = $policy_request["body"]
    $file_name = last(split($item["name"],'/'))
    $response = http_request(
      verb: "post",
      https: true,
      host: "governance-3.rightscale.com",
      href: join(["/api/governance/projects/",$project_id,"/policy_templates"]),
      body: { "UploadTemplateRequestBody": { "source": $policy_source, filename: $file_name }}
    )
  end
end

policy "upload_policy_templates" do
  validate_each $ds_combined_policy_list do
    summary_template "Policy Templates Updated"
    detail_template <<-EOS

# Policy Templates Updated

| Name | File Name | Repo Version | Long Description | Version Upgradeable |
| ---- | --------- | ------------ | ---------------- | ------------------- |
{{ range data -}}
| {{ .name }} | {{.file_name}} | {{.repo_version}} | {{.account_version}} | {{.version_upgradeable}} |
{{ end -}}
EOS

    escalate $alert
    check eq(0,1)
  end
end