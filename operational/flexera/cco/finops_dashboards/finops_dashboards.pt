name "FinOps Dashboards"
rs_pt_ver 20180301
type "policy"
short_description "Adds additional FinOps dashboards within the Flexera One organization. See the [README](https://github.com/flexera-public/policy_templates/tree/master/operational/flexera/cco/finops_dashboards/) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
category "Operational"
severity "low"
default_frequency "monthly"
info(
  version: "0.1.0",
  provider: "Flexera",
  category: "Operational",
  publish: "true",
  hide_skip_approvals: "true"
)

###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  category "Policy Settings"
  label "Email Addresses"
  description "Email addresses of the recipients you wish to notify when new dashboards are created"
  default []
end

parameter "param_dashboards" do
  type "list"
  category "Policy Settings"
  label "Dashboards"
  description "Select the specific dashboards you wish to create."
  allowed_values [ "Global CIO YTD View", "Marketplace / Operating System Overview", "Business / Product Owner", "Engineering / Operations", "Executive Summary", "Finance & Procurement", "Reservation Coverage", "Reservation Management" ]
  default [ "Global CIO YTD View", "Marketplace / Operating System Overview", "Business / Product Owner", "Engineering / Operations", "Executive Summary", "Finance & Procurement", "Reservation Coverage", "Reservation Management" ]
end

###############################################################################
# Authentication
###############################################################################

credentials "auth_flexera" do
  schemes "oauth2"
  label "flexera"
  description "Select FlexeraOne OAuth2 credential."
  tags "provider=flexera"
end

###############################################################################
# Pagination
###############################################################################

###############################################################################
# Datasources & Scripts
###############################################################################

datasource "ds_prebaked_dashboards" do
  request do
    host "raw.githubusercontent.com"
    path "/flexera-public/policy_templates/master/data/dashboards/finops_dashboards.json"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_dashboards_to_create" do
  run_script $js_dashboards_to_create, $ds_prebaked_dashboards, $param_dashboards
end

script "js_dashboards_to_create", type: "javascript" do
  parameters "ds_prebaked_dashboards", "param_dashboards"
  result "result"
  code <<-EOS
  filtered = _.filter(ds_prebaked_dashboards, function(dashboard) {
    return _.contains(param_dashboards, dashboard["name"])
  })

  result = _.map(filtered, function(dashboard) {
    body = {
      area: "OrgDashboard",
      id: "new-dashboard",
      config: dashboard["config"],
      name: [ "FinOps - ", dashboard["name"] ].join(""),
      visibility: "public",
      isDefault: false
    }

    return {
      body: JSON.stringify(body)
    }
  })
EOS
end

datasource "ds_create_dashboards" do
  iterate $ds_dashboards_to_create
  request do
    auth $auth_flexera
    host rs_optima_host
    path join(["/bill-analysis/orgs/", rs_org_id, "/dashboards"])
    header "Api-Version", "0.1"
    header "User-Agent", "RS Policies"
    body val(iter_item, "body")
    ignore_status [ 409 ] # Ignore conflicts since user may have already created one of these dashboards
  end
  result do
    encoding "json"
    field "id", jmes_path(response, "id")
    field "kind", jmes_path(response, "kind")
    field "href", jmes_path(response, "href")
    field "area", jmes_path(response, "area")
    field "name", jmes_path(response, "name")
    field "config", jmes_path(response, "config")
    field "visibility", jmes_path(response, "visibility")
    field "scope", jmes_path(response, "scope")
    field "created_at", jmes_path(response, "created_at")
    field "updated_at", jmes_path(response, "updated_at")
  end
end

###############################################################################
# Policy
###############################################################################

policy "pol_utilization" do
  validate_each $ds_instance_recommendations do
    summary_template "FinOps Dashboards: {{ len data }} Dashboards Created"
    check eq(val(item, "id"), "")
    escalate $esc_email
    export do
      resource_level true
      field "id" do
        label "ID"
      end
      field "name" do
        label "Name"
      end
      field "visibility" do
        label "Visibility"
      end
      field "created_at" do
        label "Created At"
      end
    end
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "esc_email" do
  automatic true
  label "Send Email"
  description "Send incident email"
  email $param_email
end
