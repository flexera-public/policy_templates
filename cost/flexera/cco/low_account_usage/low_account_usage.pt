name "Low Account Usage"
rs_pt_ver 20180301
type "policy"
short_description "Analyze all account usage and determines recommend consolidation or deletion. See the [README](https://github.com/flexera-public/policy_templates/tree/master/cost/low_account_usage/) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
severity "low"
category "Cost"
default_frequency "daily"
tenancy "single"
info(
  version: "2.4",
  provider: "Flexera Optima",
  service: "",
  policy_set: ""
)

parameter "param_threshold" do
  label "Low Account Spend Threshold"
  description "Estimated run-rate below which an account should be closed or consolidated. Example: 1000.00"
  type "number"
  default 1000
  min_value 1
  max_value 1000000
end

parameter "param_email" do
  label "Email addresses"
  description "Email addresses of the recipients you wish to notify"
  type "list"
end

parameter "param_billing_centers" do
  label "Billing Center Name"
  description "List of Billing Center Names to check. Leave blank to run policy against all Billing Centers"
  type "list"
  default []
end

parameter "param_minimum_savings_threshold" do
  label "Minimum Savings Threshold"
  description "Specify the minimum monthly savings value required for a recommendation to be issued, on a per resource basis. Note: this setting applies to all recommendations. Example: 1.00"
  type "number"
  default 1
end

credentials "auth_flexera" do
  schemes "oauth2"
  label "flexera"
  description "Select Flexera One OAuth2 credentials"
  tags "provider=flexera"
end

datasource "ds_dimensions" do
  request do
    auth $auth_flexera
    host rs_optima_host
    path join(["/bill-analysis/orgs/",rs_org_id,"/costs/dimensions"])
    header "Api-Version", "1.0"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_billing_centers" do
  request do
    auth $auth_flexera
    host rs_optima_host
    path join(["/analytics/orgs/",rs_org_id,"/billing_centers"])
    header "Api-Version", "1.0"
    header "User-Agent", "RS Policies"
    query "view", "allocation_table"
  end
  result do
    encoding "json"
    collect jmes_path(response,"[*]") do
      field "id", jmes_path(col_item,"id")
      field "name", jmes_path(col_item,"name")
      field "parent_id", jmes_path(col_item,"parent_id")
    end
  end
end

datasource "ds_new_bc_costs" do
  request do
    run_script $js_new_costs_request, rs_org_id, $ds_billing_centers, $param_billing_centers, rs_optima_host
  end
  result do
    encoding "json"
    collect jmes_path(response,"rows[*]") do
      field "vendor", jmes_path(col_item, "dimensions.vendor")
      field "vendor_account_name", jmes_path(col_item,"dimensions.vendor_account_name")
      field "cost_amortized_unblended_adj", jmes_path(col_item,"metrics.cost_amortized_blended_adj")
      field "id", jmes_path(col_item,"dimensions.billing_center_id")
      field "accountID", jmes_path(col_item,"dimensions.vendor_account")
    end
  end
end

script "js_new_costs_request", type: "javascript" do
  parameters "org_id","ds_billing_centers", "param_billing_centers", "rs_optima_host"
  result "request"
  code <<-EOS
    //https://stackoverflow.com/questions/3605214/javascript-add-leading-zeroes-to-date
    function pad(n){return n<10 ? '0'+n : n}
    var date = new Date();
    var year = date.getUTCFullYear();
    var month = (2 + date.getUTCMonth())

    if (month == 1){
      var lmonth = 12;
      var lyear = year-1 ;
    } else {
      var lmonth = month-1;
      var lyear = year ;
    }

    mo = month.toString().length > 1 ? month : '0' + month;
    lmo = lmonth.toString().length > 1 ? lmonth : '0' + lmonth;
    var yesterday = new Date(new Date().setDate(new Date().getDate()-1)).getDate()
    var next_month = lyear + "-" + lmo + "-" + pad(yesterday)
    var current_month = lyear + "-" + lmo + '-01'

    var billing_center_ids = []
    if (param_billing_centers.length === 0){
      var top_billing_centers = _.reject(ds_billing_centers, function(bc){ return bc.parent_id != null });
      billing_center_ids = _.map(top_billing_centers, function(value, key){ return value.id });
    } else {
      // get array of billing center id's that match the names in param_billing_centers.
      billing_center_names = _.map(param_billing_centers, function(name){ return name.toLowerCase(); });
      billing_center_ids = _.compact(_.map(ds_billing_centers, function(value){ if(_.contains(billing_center_names, value.name.toLowerCase())){return value.id} }));
    }

    var request = {
      auth: "auth_flexera",
      verb: "POST",
      host: rs_optima_host,
      path: "/bill-analysis/orgs/" + org_id + "/costs/aggregated",
      body_fields: {
        "dimensions": ["billing_center_id","vendor","vendor_account_name","vendor_account"],
        "granularity": "day",
        "metrics": ['cost_amortized_blended_adj'],
        "billing_center_ids": billing_center_ids,
        "start_at": current_month,
        "end_at": next_month,
        "filter": {
          "type": "not",
          "expression": {
            "dimension": "service",
            "type": "equal",
            "value": "APNFee"
          }
        }
      },
      headers: {
        "Api-Version": "1.0",
        "User-Agent": "RS Policies",
      }
    }
  EOS
end

datasource "ds_format_costs" do
  run_script $js_format_costs, $ds_new_bc_costs, $ds_billing_centers, $param_threshold, $param_minimum_savings_threshold
end

script "js_format_costs", type: "javascript" do
  parameters "new_bc_costs", "ds_billing_centers", "param_threshold", "param_minimum_savings_threshold"
  result "formatted_data"
  code <<-EOS
  //https://www.w3resource.com/javascript-exercises/javascript-date-exercise-3.php
  var getDaysInMonth = function(month,year) {
    // Here January is 1 based
    //Day 0 is the last day in the previous month
    return new Date(year, month, 0).getDate();
  // Here January is 0 based
  // return new Date(year, month+1, 0).getDate();
  };
  var date = new Date()
  var numdays = getDaysInMonth(date.getUTCMonth(),date.getUTCFullYear())
  var yesterday = new Date(new Date().setDate(new Date().getDate()-1)).getDate()

  var formatted_data = [];
  var unsorted_results = [];
  var arr_results = [];
  var bcs = [];

  var billing_centers = {}
  _.each(ds_billing_centers, function(bc){
    billing_centers[bc.id] = bc
  })

  _.each(new_bc_costs, function(nbc){
    arr_results.push({
      name: billing_centers[nbc.id].name,
      id: nbc.id,
      new_sum: nbc.cost_amortized_unblended_adj,
      vendor: nbc.vendor,
      vendor_account_name: nbc.vendor_account_name,
      accountID: nbc.accountID
    })
  })

  var groups = _.groupBy(arr_results, function(value){
    return value.bc_id + '#' + value.vendor + '#' + value.vendor_account_name;
  });

  var unsorted_results = _.map(groups, function(group){
    var arr_new_sum = _.pluck(group, 'new_sum')
    var summed = _.reduce(arr_new_sum, function(memo, num){ return memo + num; }, 0)
    var monthcomplete = yesterday / numdays
    var runrate = summed / monthcomplete
    return {
        name: group[0].name,
        id: group[0].id,
        vendor: group[0].vendor,
        vendor_account_name: group[0].vendor_account_name,
        run_rate: parseFloat(runrate).toFixed(2)
        accountID: group[0].accountID
    }
  });

  var checked_results = _.filter(unsorted_results, function(result){
    if (parseFloat(result.run_rate) <= param_threshold && parseFloat(result.run_rate) >= param_minimum_savings_threshold) {
      return result;
    }
  })

  var formatted_data = _(checked_results).chain().sortBy(function(result) {
    return result.vendor_account_name;
  }).sortBy(function(result) {
    return result.vendor;
  }).value();

  var total_sum = _.chain(formatted_data)
  .pluck('run_rate')
  .reduce(function(memo, num){ return memo + parseFloat(num); }, 0).value();
  _.each(formatted_data, function(data){ return data["total_sum"] = total_sum.toFixed(2) })
EOS
end

escalation "esc_budget_alert" do
  automatic true
  label "Send Email"
  description "Send incident email"
  email $param_email
end

policy "policy_budget_alert" do
  validate $ds_format_costs do
    summary_template "{{ rs_org_name }} (Org ID: {{ rs_org_id }}): Low Account Usage Detected Below {{parameters.param_threshold}} - Total Savings: {{with(index data 0)}}{{.total_sum}}{{end}}"
    escalate $esc_budget_alert
    check eq(size(data), 0)
    export do
      resource_level true
      field "name" do
        label "Billing Center Name"
      end
      field "vendor" do
        label "Vendor"
      end
      field "accountID" do
        label "Account ID"
      end
      field "vendor_account_name" do
        label "Account Name"
      end
      field "run_rate" do
        label "Savings"
      end
      field "id" do
        label "Id"
      end
    end
  end
end
