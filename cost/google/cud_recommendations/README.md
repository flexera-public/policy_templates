# Google Committed Use Discount Recommender

## What it does

This Policy Template reports any Committed Use Discount Recommendations generated by Google. The user can adjust which recommendations are reported via policy parameters.

## Functional Details

Recommendations are obtained via requests to the [Google Recommender API](https://cloud.google.com/docs/cuds-recommender).

### Policy Savings Details

The policy includes the estimated savings. The estimated savings is recognized if the recommended CUD is purchased. The savings values are provided directly by the [Google Recommender API](https://cloud.google.com/docs/cuds-recommender).

If the Flexera organization is configured to use a currency other than USD, the savings values will be converted from USD using the exchange rate at the time that the policy executes.

## Input Parameters

This policy has the following input parameters required when launching the policy.

- *Email Addresses* - Email addresses of the recipients you wish to notify.
- *Minimum Savings Threshold* - Minimum potential savings required to generate a recommendation.
- *Allow/Deny Projects* - Whether to treat Allow/Deny Projects List parameter as allow or deny list. Has no effect if Allow/Deny Projects List is left empty.
- *Allow/Deny Projects List* - Filter results by project ID/name, either only allowing this list or denying it depending on how the above parameter is set. Leave blank to consider all projects
- *Allow/Deny Regions* - Whether to treat Allow/Deny Regions List parameter as allow or deny list. Has no effect if Allow/Deny Regions List is left empty.
- *Allow/Deny Regions List* - Filter results by region, either only allowing this list or denying it depending on how the above parameter is set. Leave blank to consider all the regions.
- *Term* - Length of CUD term to provide recommendations for. Can be set to either `1 Year` or `3 Year`
- *Recommendation Algorithm* - The algorithm to use for generating recommendations. Can be set to either `Optimal` or `Stable Usage`.
  - `Stable Usage` covers minimum stable usage over time.
  - `Optimal` is are based on overall usage and might cover resources that are not active all the time.
  - See [Google's documentation](https://cloud.google.com/docs/cuds-recommender#understanding-recommendations) for more information.

## Policy Actions

The following policy actions are taken for any recommendations:

- Send an email report

## Prerequisites

This Policy Template requires that several APIs be enabled in your Google Cloud environment:

- [Cloud Resource Manager API](https://console.cloud.google.com/flows/enableapi?apiid=cloudresourcemanager.googleapis.com)
- [Recommender API](https://console.cloud.google.com/flows/enableapi?apiid=recommender.googleapis.com)

This Policy Template uses [Credentials](https://docs.flexera.com/flexera/EN/Automation/ManagingCredentialsExternal.htm) for authenticating to datasources -- in order to apply this policy you must have a Credential registered in the system that is compatible with this policy. If there are no Credentials listed when you apply the policy, please contact your Flexera Org Admin and ask them to register a Credential that is compatible with this policy. The information below should be consulted when creating the credential(s).

- [**Google Cloud Credential**](https://docs.flexera.com/flexera/EN/Automation/ProviderCredentials.htm#automationadmin_4083446696_1121577) (*provider=gce*) which has the following:
  - Roles
    - `Project Usage Commitment Recommender Viewer`

  - Permissions
    - `resourcemanager.projects.get`
    - `recommender.usageCommitmentRecommendations.list`
    - `billing.resourceCosts.get`*
    - `billing.accounts.getSpendingInformation`*

\* Needed for recommendations to reflect custom contract pricing. Otherwise, recommendations will use list pricing.

- [**Flexera Credential**](https://docs.flexera.com/flexera/EN/Automation/ProviderCredentials.htm) (*provider=flexera*) which has the following roles:
  - `billing_center_viewer`

The [Provider-Specific Credentials](https://docs.flexera.com/flexera/EN/Automation/ProviderCredentials.htm) page in the docs has detailed instructions for setting up Credentials for the most common providers.

## Supported Clouds

- Google

## Cost

This Policy Template does not launch any instances, and so does not incur any cloud costs.

### API Quotas

The google api sets quotas on the recommender api, which will generate a `429 RESOURCE_EXHAUSTED`. See [Quotas & Limits](https://cloud.google.com/recommender/quotas)
