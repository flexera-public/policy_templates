name "Turbonomic Credential Refresh"
rs_pt_ver 20180301
type "policy"
short_description "A policy that refreshes the cookie used to authenticate with Turbonomic APIs"
severity "low"
category "Operational"
default_frequency "hourly"
info(
  version: "0.1",
  provider: "",
  service: "",
  policy_set: "",
	publish: "false"
)

parameter "param_turbonomic_username" do
  type "string"
  label "Turbonomic Username"
  description "The username used to authenticate with Turbonomic APIs"
end

parameter "param_turbonomic_password" do
  type "string"
  no_echo true
  label "Turbonomic Password"
  description "The password used to authenticate with Turbonomic APIs"
end

parameter "param_turbonomic_host" do
  type "string"
  label "Turbonomic Host"
  description "Your Turbonomic host or IP."
end

###############################################################################
# Authentication
###############################################################################

credentials "auth_flexera" do
  schemes "oauth2"
  label "flexera"
  description "Select Flexera One OAuth2 credentials"
  tags "provider=flexera"
end

###############################################################################
# Datasources & Scripts
###############################################################################

# Retrieves all applied policies in the project where this policy is applied
datasource "ds_applied_policies" do
  request do
    auth $auth_flexera
    host rs_governance_host
    path join(["/api/governance/projects/", rs_project_id, "/applied_policies"], "")
    header "Api-Version", "1.0"
  end
  result do
    encoding "json"
    collect jq(response, ".items[]") do
      field "id", val(col_item, "id")
      field "name", val(col_item, "name")
      field "info_source", jq(col_item, ".info.source")
    end
  end
end

# Filters the applied policy where the info.source is set to either "Turbonomic" or "Turbonomics"
datasource "ds_turbo_applied_policies" do
  run_script $js_filter_turbo_policies, $ds_applied_policies
end

script "js_filter_turbo_policies", type: "javascript" do
  parameters "applied_policies"
  result "filtered_policies"
  code <<-EOS
  var filtered_policies = _.map(_.filter(applied_policies, function(applied_policy) {
    return applied_policy.info_source == "Turbonomics" || applied_policy.info_source == "Turbonomic"
  }), function(policy){policy.time = Date.now(); return policy});
  EOS
end

###############################################################################
# Policy & Escalation
###############################################################################

policy "pol_turbo_applied_policies" do
  validate $ds_turbo_applied_policies do
    summary_template "Turbo policies found"
    detail_template <<-EOS
    The following applied policies are running for Turbonomics. The auth_token parameter will be updated
    with refreshed cookie.

    | ID | Name | Source |
    | -- | ---- | ------ |
{{ range data -}}
  | {{.id}} | {{.name}} | {{.info_source}} |
{{ end -}}
EOS
    check eq(size(data), 0)
    escalate $esc_update_cookie
  end
end

escalation "esc_update_cookie" do
  run "update_cookie", data, $param_turbonomic_username, $param_turbonomic_password, $param_turbonomic_host, rs_governance_host, rs_project_id
end

define update_cookie($turbo_policies, $param_turbonomic_username, $param_turbonomic_password, $param_turbonomic_host, $gov_host, $proj_id) do
  # Authenticate with Turbonomic API and get a fresh cookie
  $response = http_request(
    verb: "post",
    https: true,
    host: $param_turbonomic_host,
    href: "/api/v3/login",
    body: "username=" + $param_turbonomic_username + "&password=" + $param_turbonomic_password,
    headers: {
      "content-type": "application/x-www-form-urlencoded"
    }
  )
  if $response["code"] != 200
    raise "Unexpected response code from Turbo login endpoint: " + $response["code"] + " body: " + to_s($response["body"])
  end
  $cookie = split($response["headers"]["Set-Cookie"], ";")[0]
  # Go through all Turbonomic policies
  foreach $policy in $turbo_policies do
    # Retrieve the policy details so we can patch it with updated auth_cookie
    $response = http_get(
      url: "https://" + $gov_host + "/api/governance/projects/" + $proj_id + "/applied_policies/" + $policy["id"],
      headers: {
        "Api-Version": "1.0"
      },
      auth: $$auth_flexera
    )
    if $response["code"] != 200
      raise "Unexpected response code from policy template show: " + $response["code"] + " body: " + to_s($response["body"])
    end
    $options = $response["body"]["options"]
    $modified = []
    $found = false
    if $options != null
      foreach $option in $options do
        if $option["name"] == "auth_cookie" || $option["name"] == "param_turbonomic_auth_cookie"
          $option["value"] = $cookie
          $found = true
        end
        $modified << $option
      end
      if $found
        # If the applied policy has the auth_cookie or param_turbonomic_auth_cookie parameter, we'll update with a fresh value
        $response = http_patch(
          url: "https://" + $gov_host + "/api/governance/projects/" + $proj_id + "/applied_policies/" + $policy["id"],
          headers: {
            "Api-Version": "1.0"
          },
          auth: $$auth_flexera,
          body: {
            options: $modified
          }
        )
        if $response["code"] != 204
          raise "Unexpected response code from policy template update: " + $response["code"] + " body: " + to_s($response["body"])
        end
      end
    end
  end
end
