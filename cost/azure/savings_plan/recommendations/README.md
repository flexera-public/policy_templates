# Azure Savings Plan Recommendations

## What It Does

This policy template reports any Savings Plan Purchase Recommendations generated by Azure. The user can adjust which recommendations are reported via policy parameters.

## How It Works

Recommendations are obtained via requests to the [Azure Cost Management API](https://learn.microsoft.com/en-us/rest/api/cost-management/benefit-recommendations/list?tabs=HTTP).

### Policy Savings Details

The policy includes several cost and savings metrics provided directly by the [Azure Cost Management API](https://learn.microsoft.com/en-us/rest/api/cost-management/benefit-recommendations/list?tabs=HTTP):

- *Current Monthly Cost* - Total monthly cost for the covered resources before any Savings Plans are purchased.
- *New Monthly Cost with Savings Plan* - New monthly cost for the covered resources after any Savings Plans are purchased. Should always be lower than the `Current Monthly Cost`
- *Estimated Monthly Savings* - The difference between `Current Monthly Cost` and `New Monthly Cost with Savings Plan`, which indicates how much would be saved by acting on the recommendation and purchasing the Savings Plans.
- *Recommended Quantity to Purchase* - Recommended number of Savings Plan hours to purchase.
- *Total Hours* - The total hours for which the cost is covered. Roughly equal to the number of hours in the `Look Back Period` in most cases.
- *Benefit Cost (Hours)* - The estimated hourly cost with benefit. Equal to `Recommended Quantity to Purchase` * `Total Hours`.
- *Wastage Cost (Hours)* - Estimated unused portion of `Benefit Cost (Hours)`.
- *Overage Cost (Hours)* - The difference between `New Monthly Cost with Savings Plan` and `Benefit Cost (Hours)` across `Total Hours`

If the Flexera organization is configured to use a currency other than the one the [Azure Cost Management API](https://learn.microsoft.com/en-us/rest/api/cost-management/benefit-recommendations/list?tabs=HTTP) returns, the savings values will be converted using the exchange rate at the time that the policy executes.

## Input Parameters

This policy has the following input parameters required when launching the policy.

- *Email Addresses* - Email addresses of the recipients you wish to notify when new incidents are created.
- *Azure Endpoint* - The endpoint to send Azure API requests to. Recommended to leave this at default unless using this policy with Azure China.
- *Minimum Savings Threshold* - Minimum potential savings required to generate a recommendation.
- *Allow/Deny Subscriptions* - Allow or Deny entered Subscriptions to filter results.
- *Allow/Deny Subscriptions List* - A list of allowed or denied Subscription IDs/names. Leave blank to check all Subscriptions.
- *Look Back Period* - Number of days of prior usage to analyze.
- *Savings Plan Term* - Length of reservation term to provide recommendations for. Can be set to either `1 Year` or `3 Year`
- *Savings Plan Scope* - The scope to provide recommendations for. Select `Shared` to not have recommendations scoped to individual Subscriptions or Resource Groups.

## Policy Actions

The following policy actions are taken for any recommendations:

- Send an email report

## Prerequisites

This Policy Template uses [Credentials](https://docs.flexera.com/flexera/EN/Automation/ManagingCredentialsExternal.htm) for authenticating to datasources -- in order to apply this policy you must have a Credential registered in the system that is compatible with this policy. If there are no Credentials listed when you apply the policy, please contact your Flexera Org Admin and ask them to register a Credential that is compatible with this policy. The information below should be consulted when creating the credential(s).

- [**Azure Resource Manager Credential**](https://docs.flexera.com/flexera/EN/Automation/ProviderCredentials.htm#automationadmin_109256743_1124668) (*provider=azure_rm*) which has the following permissions:
  - `Microsoft.CostManagement/benefitRecommendations/read`

- [**Flexera Credential**](https://docs.flexera.com/flexera/EN/Automation/ProviderCredentials.htm) (*provider=flexera*) which has the following roles:
  - `billing_center_viewer`

The [Provider-Specific Credentials](https://docs.flexera.com/flexera/EN/Automation/ProviderCredentials.htm) page in the docs has detailed instructions for setting up Credentials for the most common providers.

## Supported Clouds

- Azure

## Cost

This Policy Template does not launch any instances, and so does not incur any cloud costs.
