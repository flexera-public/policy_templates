name "Azure MCA Expiring Reserved Instances"
rs_pt_ver 20180301
type "policy"
short_description "A policy that sends email notifications when an Azure MCA Reserved Instance are about to expire. See the [README](https://github.com/rightscale/policy_templates/tree/master/cost/azure/reserved_instances/mca_expiration) and [docs.rightscale.com/policies](http://docs.rightscale.com/policies/) to learn more."
long_description ""
severity "low"
category "Cost"
tenancy "single"
info(
  version: "2.0",
  provider: "Azure",
  service: "",
  policy_set: ""
)

###############################################################################
# Parameters
###############################################################################

parameter "param_days_expiration" do
  type "number"
  label "Number of days to prior to expiration date to trigger incident"
end

parameter "param_email" do
  type "list"
  label "Email addresses of the recipients you wish to notify"
end

###############################################################################
# Authentication
###############################################################################

#authenticate with Azure
credentials "azure_auth" do
  schemes "oauth2"
  label "Azure"
  description "Select the Azure Resource Manager Credential from the list."
  tags "provider=azure_rm"
end

###############################################################################
# Pagination
###############################################################################

pagination "azure_pagination" do
  get_page_marker do
    body_path "nextLink"
  end
  set_page_marker do
    uri true
  end
end

###############################################################################
# Datasources
###############################################################################

datasource "ds_ri_reservation_orders" do
  request do
    auth $azure_auth
    pagination $azure_pagination
    host "management.azure.com"
    path join(["/providers/Microsoft.Capacity/reservationOrders"])
    query "api-version","2019-04-01"
    header "User-Agent", "RS Policies"
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "reservation_id", jmes_path(col_item,"name")
    end
  end
end

datasource "ds_reservations" do
  iterate $ds_ri_reservation_orders
  request do
    auth $azure_auth
    pagination $azure_pagination
    host "management.azure.com"
    path join(["/providers/Microsoft.Capacity/reservationOrders/", val(iter_item,"reservation_id"), "/reservations"])
    query "api-version","2019-04-01"
    header "User-Agent", "RS Policies"
    ignore_status [404]
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "arm_sku_name", jmes_path(col_item,"sku.name")
      field "expiration_date", jmes_path(col_item,"properties.expiryDate")
      field "purchasing_subscription_name", jmes_path(col_item,"properties.billingScopeId")
      field "quantity", jmes_path(col_item,"properties.quantity")
      field "region", jmes_path(col_item,"location")
      field "reservation_id", jmes_path(col_item,"name")
      field "reservation_order_id", val(iter_item,"reservation_id")
      field "reservation_order_name", jmes_path(col_item,"name")
    end
  end
end

datasource "ds_filtered_reservations" do
  run_script $js_filtered_reservations, $ds_reservations, $param_days_expiration
end

###############################################################################
# Scripts
###############################################################################

script "js_filtered_reservations", type: "javascript" do
  parameters "reservations","param_days_expiration"
  result "content"
  code <<-EOS
    var content=[];
    var now = new Date();
    var one_day=1000*60*60*24;
    var date1_ms = now.getTime();

    for(var i=0; i < reservations.length ; i++){
      reservation = reservations[i]
      var date2_ms = (new Date(reservation['expiration_date'])).getTime();
      var difference_ms = date2_ms - date1_ms;
      var daysLeft = Math.round(difference_ms/one_day);

      if(daysLeft <= param_days_expiration) {
        content.push({
          arm_sku_name: reservation['arm_sku_name'],
          expiration_date: reservation['expiration_date'],
          purchasing_subscription_name: reservation['purchasing_subscription_name'],
          quantity: reservation['quantity'],
          region: reservation['region'],
          reservation_id: reservation['reservation_id'],
          reservation_order_id: reservation['reservation_order_id'],
          reservation_order_name: reservation['reservation_order_name'],
          daysExpiration: daysLeft
        })
      }
    }
    content = _.sortBy(content, 'reservation_id');
    content = _.sortBy(content, 'reservation_order_id');
EOS
end

###############################################################################
# Policy
###############################################################################

policy "ri_expiration" do
  validate $ds_filtered_reservations do
    summary_template "{{ rs_org_name }} (Org ID: {{ rs_org_id }}): {{ len data }} Reserved Instance(s) in Microsoft Azure MCA Expiring"
    escalate $report_expiring_reserved_instances
    check eq(size(data),0)
    export do
      resource_level true
      field "id" do
        label "Reservation Id"
        path "reservation_id"
      end
      field "reservation_order_id" do
        label "Reservation Order Id"
      end
      field "reservation_order_name" do
        label "Reservation Order Name"
      end
      field "purchasing_subscription_id" do
        label "Subscription ID"
      end
      field "region" do
        label "Location"
      end
      field "arm_sku_name" do
        label "ARM SKU"
      end
      field "quantity" do
        label "Quantity"
      end
      field "expiration_date" do
        label "Expiration Date"
      end
      field "daysExpiration" do
        label "Days Until Expiration"
      end
    end
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "report_expiring_reserved_instances" do
  automatic true
  label "Send Email"
  description "Send incident email"
  email $param_email
end
