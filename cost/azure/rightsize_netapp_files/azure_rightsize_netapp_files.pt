name "Azure Rightsize NetApp Files"
rs_pt_ver 20180301
type "policy"
short_description "Cheks for oversized NetApp Volumes and suggest recommendations to save money. See the [README](https://github.com/flexera-public/policy_templates/tree/master/cost/azure/rightsize_netapp_files/) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
category "Cost"
severity "low"
default_frequency "weekly"
info(
  version: "0.0",
  provider: "Azure",
  service: "NetApp Files",
  policy_set: "Rightsize NetApp Files",
  recommendation_type: "Usage Reduction"
)

###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  category "Policy Settings"
  label "Email Addresses"
  description "A list of email addresses to notify."
  default []
end

parameter "param_azure_endpoint" do
  type "string"
  category "Policy Settings"
  label "Azure Endpoint"
  description "Select the API endpoint to use for Azure. Use default value of management.azure.com unless using Azure China."
  allowed_values "management.azure.com", "management.chinacloudapi.cn"
  default "management.azure.com"
end

parameter "param_stats_underutil_threshold_pool_value" do
  type "number"
  category "Statistics"
  label "Underutilized NetApp Files Capacity Pool Threshold (%)"
  description "The NetApp Files threshold at which to consider a capacity pool to be 'underutilized' and therefore be flagged for downsizing. Set to -1 to ignore capacity pool utilization"
  min_value -1
  max_value 100
  default 40
end

parameter "param_stats_underutil_threshold_volume_value" do
  type "number"
  category "Statistics"
  label "Underutilized NetApp Files Volume Threshold (%)"
  description "The NetApp Files threshold at which to consider a volume to be 'underutilized' and therefore be flagged for downsizing. Set to -1 to ignore volume utilization"
  min_value -1
  max_value 100
  default 40
end

parameter "param_subscriptions_allow_or_deny" do
  type "string"
  category "Filters"
  label "Allow/Deny Subscriptions"
  description "Allow or Deny entered Subscriptions"
  allowed_values "Allow", "Deny"
  default "Allow"
end

parameter "param_subscriptions_list" do
  type "list"
  category "Filters"
  label "Allow/Deny Subscriptions List"
  description "A list of allowed or denied Subscription IDs/names"
  default []
end

###############################################################################
# Authentication
###############################################################################

credentials "auth_azure" do
  schemes "oauth2"
  label "Azure"
  description "Select the Azure Resource Manager Credential from the list."
  tags "provider=azure_rm"
end

###############################################################################
# Pagination
###############################################################################

pagination "pagination_azure" do
  get_page_marker do
    body_path "nextLink"
  end
  set_page_marker do
    uri true
  end
end

###############################################################################
# Datasources & Scripts
###############################################################################

datasource "ds_azure_subscriptions" do
  request do
    auth $auth_azure
    pagination $pagination_azure
    host $param_azure_endpoint
    path "/subscriptions/"
    query "api-version","2020-01-01"
    header "User-Agent", "RS Policies"
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "id", jmes_path(col_item, "subscriptionId")
      field "name", jmes_path(col_item, "displayName")
      field "state", jmes_path(col_item, "state")
    end
  end
end

datasource "ds_azure_subscriptions_filtered" do
  run_script $js_azure_subscriptions_filtered, $ds_azure_subscriptions, $param_subscriptions_allow_or_deny, $param_subscriptions_list
end

script "js_azure_subscriptions_filtered", type: "javascript" do
  parameters "ds_azure_subscriptions", "param_subscriptions_allow_or_deny", "param_subscriptions_list"
  result "result"
  code <<-EOS
  if (param_subscriptions_list.length > 0) {
    result = _.filter(ds_azure_subscriptions, function(subscription) {
      include_subscription = _.contains(param_subscriptions_list, subscription['id']) || _.contains(param_subscriptions_list, subscription['name'])

      if (param_subscriptions_allow_or_deny == "Deny") {
        include_subscription = !include_subscription
      }

      return include_subscription
    })
  } else {
    result = ds_azure_subscriptions
  }
EOS
end

datasource "ds_resource_groups" do
  iterate $ds_azure_subscriptions_filtered
  request do
    auth $auth_azure
    host $param_azure_endpoint
    path join(["/subscriptions/", val(iter_item, "id"), "/resourceGroups"])
    query "api-version", "2020-09-01"
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "subscription_id", val(iter_item, "id")
      field "resource_group_name", jmes_path(col_item, "name")
    end
  end
end

datasource "ds_naf_accounts" do
  iterate $ds_resource_groups
  request do
    auth $auth_azure
    host $param_azure_endpoint
    path join(["/subscriptions/", val(iter_item, "subscription_id"), "/resourceGroups/", val(iter_item, "resource_group_name"), "/providers/Microsoft.NetApp/netAppAccounts"])
    query "api-version", "2023-05-01"
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "subscription_id", jmes_path(iter_item, "subscription_id")
      field "resource_group_name", jmes_path(iter_item, "resource_group_name")
      field "naf_account_name", jmes_path(col_item, "name")
    end
  end
end

datasource "ds_naf_capacity_pools_v1" do
  iterate $ds_naf_accounts
  request do
    auth $auth_azure
    host $param_azure_endpoint
    path join(["/subscriptions/", val(iter_item, "subscription_id"), "/resourceGroups/", val(iter_item, "resource_group_name"), "/providers/Microsoft.NetApp/netAppAccounts/", val(iter_item, "naf_account_name"), "/capacityPools"])
    query "api-version", "2023-05-01"
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "subscription_id", jmes_path(iter_item, "subscription_id")
      field "resource_group_name", jmes_path(iter_item, "resource_group_name")
      field "naf_account_name", jmes_path(iter_item, "naf_account_name")
      field "naf_pool_id", jmes_path(col_item, "id")
      field "naf_pool_name", jmes_path(col_item, "name")
      field "naf_pool_size", jmes_path(col_item, "properties.size")
    end
  end
end

datasource "ds_naf_capacity_pools_v2" do
  run_script $js_naf_capacity_pools_v2, $ds_naf_capacity_pools_v1
end

script "js_naf_capacity_pools_v2", type: "javascript" do
  parameters "ds_naf_capacity_pools_v1"
  result "result"
  code <<-EOS
  var result = _.map(ds_naf_capacity_pools_v1, function(item) {
    item.naf_pool_name = item.naf_pool_name.split("/")[1]
    return item
  })
EOS
end

datasource "ds_naf_pool_metrics" do
  iterate $ds_naf_capacity_pools_v2
  request do
    auth $auth_azure
    host $param_azure_endpoint
    path join([val(iter_item, "naf_pool_id"), "/providers/Microsoft.Insights/metrics"])
    query "api-version", "2018-01-01"
    query "metricnames", "VolumePoolAllocatedUsed,VolumePoolAllocatedSize"
  end
  result do
    encoding "json"
    field "subscription_id", jmes_path(iter_item, "subscription_id")
    field "resource_group_name", jmes_path(iter_item, "resource_group_name")
    field "naf_account_name", jmes_path(iter_item, "naf_account_name")
    field "naf_pool_id", jmes_path(iter_item, "naf_pool_id")
    field "naf_pool_name", jmes_path(iter_item, "naf_pool_name")
    field "naf_pool_size", jmes_path(iter_item, "naf_pool_size")
    field "naf_pool_metrics", jmes_path(response, "value[*]")
  end
end

datasource "ds_naf_volumes" do
  iterate $ds_naf_capacity_pools_v2
  request do
    auth $auth_azure
    host $param_azure_endpoint
    path join(["/subscriptions/", val(iter_item, "subscription_id"), "/resourceGroups/", val(iter_item, "resource_group_name"), "/providers/Microsoft.NetApp/netAppAccounts/", val(iter_item, "naf_account_name"), "/capacityPools/", val(iter_item, "naf_pool_name"), "/volumes"])
    query "api-version", "2023-05-01"
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "subscription_id", jmes_path(iter_item, "subscription_id")
      field "resource_group_name", jmes_path(iter_item, "resource_group_name")
      field "naf_account_name", jmes_path(iter_item, "naf_account_name")
      field "naf_pool_id", jmes_path(iter_item, "naf_pool_id")
      field "naf_pool_name", jmes_path(iter_item, "naf_pool_name")
      field "naf_pool_size", jmes_path(iter_item, "naf_pool_size")
      field "naf_volume_name", jmes_path(col_item, "name")
      field "naf_volume_id", jmes_path(col_item, "id")
    end
  end
end

datasource "ds_naf_volume_metrics" do
  iterate $ds_naf_volumes
  request do
    auth $auth_azure
    host $param_azure_endpoint
    path join([val(iter_item, "naf_volume_id"), "/providers/Microsoft.Insights/metrics"])
    query "api-version", "2018-01-01"
    query "metricnames", "VolumeLogicalSize,VolumeAllocatedSize,VolumeConsumedSizePercentage"
  end
  result do
    encoding "json"
    field "subscription_id", jmes_path(iter_item, "subscription_id")
    field "resource_group_name", jmes_path(iter_item, "resource_group_name")
    field "naf_account_name", jmes_path(iter_item, "naf_account_name")
    field "naf_pool_id", jmes_path(iter_item, "naf_pool_id")
    field "naf_pool_name", jmes_path(iter_item, "naf_pool_name")
    field "naf_pool_size", jmes_path(iter_item, "naf_pool_size")
    field "naf_volume_name", jmes_path(iter_item, "naf_volume_name")
    field "naf_volume_id", jmes_path(iter_item, "naf_volume_id")
    field "naf_volume_metrics", jmes_path(response, "value[*]")
  end
end

datasource "ds_naf_oversized_pools" do
  run_script $js_naf_oversized_pools, $ds_naf_pool_metrics, $param_stats_underutil_threshold_pool_value, $ds_naf_get_costs
end

script "js_naf_oversized_pools", type: "javascript" do
  parameters "ds_naf_pool_metrics", "param_stats_underutil_threshold_pool_value", "ds_naf_get_costs"
  result "result"
  code <<-EOS
  result = []
  var minPoolSize = 2048
  var maxPoolSize = 1024000
  function getCost(poolSize) {
    var savings = 0.0
    if (ds_naf_get_costs[0].retailPrice != undefined) {
      savings = poolSize * ds_naf_get_costs[0].retailPrice * 24 * 30
    }
    return savings
  }
  function bytesToGibibytes(bytes) {
    return Math.round(bytes * 9.3132257461548e-10)
  }
  function poolCanBeResized(size, recommendedSize) {
    if (size == minPoolSize && recommendedSize < minPoolSize) {
      return false
    }
    if (size == maxPoolSize && recommendedSize > maxPoolSize) {
      return false
    }
    return true
  }
  _.each(ds_naf_pool_metrics, function(pool){
    _.each(pool.naf_pool_metrics, function (metric) {
      var lastPointInTS = metric.timeseries[0].data[metric.timeseries[0].data.length - 1].average
      switch (metric.name.value) {
        case "VolumePoolAllocatedUsed":
          pool.consumedSize = bytesToGibibytes(lastPointInTS)
          break;
        case "VolumePoolAllocatedSize":
          pool.allocatedSize = bytesToGibibytes(lastPointInTS)
          break;
      }
    })
    if (pool.allocatedSize != undefined && pool.consumedSize != undefined) {
      var poolConsumedPercentage = Math.round(pool.consumedSize * 100 / pool.allocatedSize)
      if (poolConsumedPercentage != param_stats_underutil_threshold_pool_value) {
        var poolRecommendedSize = Math.round(pool.consumedSize * 100 / param_stats_underutil_threshold_pool_value)
        if (poolCanBeResized(pool.allocatedSize, poolRecommendedSize)) {
          if (poolRecommendedSize < minPoolSize) {
            poolRecommendedSize = minPoolSize
          }
          if (poolRecommendedSize > maxPoolSize) {
            poolRecommendedSize = maxPoolSize
          }
          var savings = getCost(pool.allocatedSize) - getCost(poolRecommendedSize)
          if (savings < 0) {
            savings = 0
          }
          result.push({
            resourceID: pool['naf_pool_id'],
            resourceName: pool['naf_pool_name'],
            poolSize: pool['allocatedSize'],
            poolConsumed: pool['consumedSize'],
            poolConsumedPercentage: poolConsumedPercentage,
            poolRecommendedSize: poolRecommendedSize,
            savings: parseFloat(savings.toFixed(3))
            id: pool['naf_pool_id']
          })
        }
      }
    }
  })
EOS
end

datasource "ds_naf_oversized_volumes" do
  run_script $js_naf_oversized_volumes, $ds_naf_volume_metrics, $ds_naf_pool_metrics, $param_stats_underutil_threshold_pool_value, $param_stats_underutil_threshold_volume_value, $ds_naf_get_costs
end

script "js_naf_oversized_volumes", type: "javascript" do
  parameters "ds_naf_volume_metrics", "ds_naf_pool_metrics", "param_stats_underutil_threshold_pool_value", "param_stats_underutil_threshold_volume_value", "ds_naf_get_costs"
  result "result"
  code <<-EOS
  result = []
  var minPoolSize = 2048
  var maxPoolSize = 1024000
  var minVolSize = 100
  var maxVolSize = 512000
  function getCost(poolSize) {
    var savings = 0.0
    if (ds_naf_get_costs[0].retailPrice != undefined) {
      savings = poolSize * ds_naf_get_costs[0].retailPrice * 24 * 30
    }
    return savings
  }
  function bytesToGibibytes(bytes) {
    return Math.round(bytes * 9.3132257461548e-10)
  }
  function poolCanBeResized(size, recommendedSize) {
    if (size == minPoolSize && recommendedSize < minPoolSize) {
      return false
    }
    if (size == maxPoolSize && recommendedSize > maxPoolSize) {
      return false
    }
    return true
  }
  function volumeCanBeResized(size, recommendedSize) {
    if (size == minVolSize && recommendedSize < minVolSize) {
      return false
    }
    if (size == maxVolSize && recommendedSize > maxVolSize) {
      return false
    }
    return true
  }
  _.each(ds_naf_volume_metrics, function(volume) {
    _.each(volume.naf_volume_metrics, function(metric) {
      var lastPointInTS = metric.timeseries[0].data[metric.timeseries[0].data.length - 1].average
      switch (metric.name.value) {
        case "VolumeLogicalSize":
          volume.volume_logical_size = bytesToGibibytes(lastPointInTS)
          break;
        case "VolumeAllocatedSize":
          volume.volume_allocated_size = bytesToGibibytes(lastPointInTS)
          break;
        case "VolumeConsumedSizePercentage":
          volume.volume_consumed_size_percentage = Math.round(lastPointInTS)
          break;
      }
    })
    // Check if volume contains required metrics info
    if (volume.volume_logical_size != undefined && volume.volume_allocated_size != undefined && volume.volume_consumed_size_percentage != undefined) {
      _.each(ds_naf_pool_metrics, function(pool){
        if (pool.naf_pool_name == volume.naf_pool_name) {
          _.each(pool.naf_pool_metrics, function (metric) {
            var lastPointInTS = metric.timeseries[0].data[metric.timeseries[0].data.length - 1].average
            switch (metric.name.value) {
              case "VolumePoolAllocatedUsed":
                volume.volumePoolAllocatedUsed = bytesToGibibytes(lastPointInTS)
                break;
              case "VolumePoolAllocatedSize":
                volume.poolAllocatedSize = bytesToGibibytes(lastPointInTS)
                break;
            }
          })
        }
      })
      if (volume.volumePoolAllocatedUsed != undefined && volume.poolAllocatedSize != undefined) {
        if (volume.volume_consumed_size_percentage != param_stats_underutil_threshold_volume_value) {
          var recommendedVolumeAllocatedSize = volume.volume_logical_size * 100 / param_stats_underutil_threshold_volume_value
          if (volumeCanBeResized(volume.volume_allocated_size, recommendedVolumeAllocatedSize)) {
            if (recommendedVolumeAllocatedSize < minVolSize) {
              recommendedVolumeAllocatedSize = minVolSize
            }
            if (recommendedVolumeAllocatedSize > maxVolSize) {
              recommendedVolumeAllocatedSize = maxVolSize
            }
            var newPoolAllocatedUsed = volume.volumePoolAllocatedUsed - (volume.volume_allocated_size - recommendedVolumeAllocatedSize)
            var recommendedPoolSize = newPoolAllocatedUsed * 100 / param_stats_underutil_threshold_pool_value
            if (poolCanBeResized(volume.poolAllocatedsize, recommendedPoolSize)) {
              if (recommendedPoolSize < minPoolSize) {
                recommendedPoolSize = minPoolSize
              }
              if (recommendedPoolSize > maxPoolSize) {
                recommendedPoolSize = maxPoolSize
              }
              var rightsizePool = recommendedPoolSize - volume.poolAllocatedSize
              var savings = 0.0
              savings = getCost(volume.poolAllocatedSize) - getCost(recommendedPoolSize)
              if (savings < 0) {
                savings = 0
              }
              result.push({
                resourceID: volume['naf_volume_id'],
                resourceName: volume['naf_volume_name'],
                volumeAllocatedSize: volume['volume_allocated_size'],
                volumeLogicalSize: volume['volume_logical_size'],
                volumeConsumedSizePercentage: volume['volume_consumed_size_percentage'],
                recommendedVolumeAllocatedSize: recommendedVolumeAllocatedSize,
                poolName: volume['naf_pool_name'],
                poolSize: bytesToGibibytes(volume['naf_pool_size']),
                recommendedRightsize: rightsizePool,
                savings: parseFloat(savings.toFixed(3))
                id: volume['naf_volume_id'],
              })
            }
          }
        }
      }
    }
  })
EOS
end


datasource "ds_naf_get_costs" do
  request do
    host "prices.azure.com"
    path "/api/retail/prices"
    query "api-version", "2021-10-01-preview"
    query "$filter","serviceName eq 'Azure NetApp Files' and location eq 'US West' and (skuName eq 'Premium' or skuName eq 'Standard' or skuName eq 'Ultra')"
  end
  result do
    encoding "json"
    collect jmes_path(response, "Items[*]") do
      field "retailPrice", jmes_path(col_item, "retailPrice")
    end
  end
end

###############################################################################
# Policy
###############################################################################

policy "pol_azure_rightsize_netapp_files" do
  validate $ds_naf_oversized_pools do
    summary_template "There are {{ len data }} oversized Azure NetApp File Pools"
    check eq(size(data), 0)
    escalate $esc_email
    export do
      resource_level true
      field "resourceID" do
        label "Resource ID"
      end
      field "resourceName" do
        label "Resource Name"
      end
      field "poolSize" do
        label "Capacity Pool Size (GiB)"
      end
      field "poolConsumed" do
        label "Capacity Pool Consumed (GiB)"
      end
      field "poolConsumedPercentage" do
        label "Capacity Pool Consumed Percentage (%)"
      end
      field "poolRecommendedSize" do
        label "Capacity Pool Recommended Size (GiB)"
      end
      field "savings" do
        label "Estimated Monthly Savings"
      end
      field "id" do
        label "ID"
      end
    end
  end
  validate $ds_naf_oversized_volumes do
    summary_template "There are {{ len data }} oversized Azure NetApp File Volumes"
    check eq(size(data), 0)
    escalate $esc_email
    export do
      resource_level true
      field "resourceID" do
        label "Resource ID"
      end
      field "resourceName" do
        label "Resource Name"
      end
      field "volumeAllocatedSize" do
        label "Volume Allocated Size (GiB)"
      end
      field "volumeLogicalSize" do
        label "Volume Logical Size (GiB)"
      end
      field "volumeConsumedSizePercentage" do
        label "Volume Consumed Size Percentage (%)"
      end
      field "recommendedVolumeAllocatedSize" do
        label "Volume Recommended Allocated Size (GiB)"
      end
      field "poolName" do
        label "Capacity Pool Name"
      end
      field "poolSize" do
        label "Capacity Pool Size (GiB)"
      end
      field "recommendedRightsize" do
        label "Recommended Pool Rightsize (GiB)"
      end
      field "savings" do
        label "Estimated Monthly Savings"
      end
      field "id" do
        label "ID"
      end
    end
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "esc_email" do
  automatic true
  label "Send Email"
  description "Send incident email."
  email $param_email
end

###############################################################################
# Cloud Workflow
###############################################################################
