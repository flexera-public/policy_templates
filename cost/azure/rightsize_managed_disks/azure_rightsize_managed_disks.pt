name "Azure Rightsize Managed Disks"
rs_pt_ver 20180301
type "policy"
short_description "Cheks for oversized managed disks and suggest recommendations to save money. See the [README](https://github.com/flexera-public/policy_templates/tree/master/cost/azure/rightsize_managed_disks/) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
category "Cost"
severity "low"
default_frequency "weekly"
info(
  version: "0.0",
  provider: "Azure",
  service: "Managed Disks",
  policy_set: "Rightsize Managed Disks",
  recommendation_type: "Usage Reduction"
)

###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  category "Policy Settings"
  label "Email Addresses"
  description "A list of email addresses to notify."
  default []
end

parameter "param_azure_endpoint" do
  type "string"
  category "Policy Settings"
  label "Azure Endpoint"
  description "Select the API endpoint to use for Azure. Use default value of management.azure.com unless using Azure China."
  allowed_values "management.azure.com", "management.chinacloudapi.cn"
  default "management.azure.com"
end

parameter "param_subscriptions_to_check" do
  type "list"
  category "Filters"
  label "Azure subscriptions to check"
  description "Enter the subscription IDs that you want this policy to check for oversized managed disks."
  default []
end

parameter "param_min_disk_space_pct_used" do
  type "number"
  category "Filters"
  label "Minimum percentage used"
  description "Enter the minimum disk space percentage used to trigger a sizing recommendation on the managed disk."
  default 50
end

###############################################################################
# Authentication
###############################################################################

credentials "auth_azure" do
  schemes "oauth2"
  label "Azure"
  description "Select the Azure Resource Manager Credential from the list."
  tags "provider=azure_rm"
end

credentials "auth_azure_log_analytics" do
  schemes "oauth2"
  label "Azure"
  description "Select the Azure Resource Manager Credential from the list. This needs to be created using https://api.loganalytics.io as the resource parameter."
  tags "provider=azure_rm"
end

###############################################################################
# Pagination
###############################################################################

###############################################################################
# Datasources & Scripts
###############################################################################

datasource "ds_log_analytics_workspaces" do
  iterate $ds_subscriptions_to_check
  request do
    auth $auth_azure
    host $param_azure_endpoint
    path join(["/subscriptions/", iter_item, "/providers/Microsoft.OperationalInsights/workspaces"])
    query "api-version", "2022-10-01"
    header "User-Agent", "RS Policies"
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "id", jmes_path(col_item, "id")
      field "customerId", jmes_path(col_item, "properties.customerId")
      field "name", jmes_path(col_item, "name")
      field "location", jmes_path(col_item, "location")
    end
  end
end

datasource "ds_subscriptions_to_check" do
  run_script $js_subscriptions_to_check, $param_subscriptions_to_check
end

script "js_subscriptions_to_check", type: "javascript" do
  parameters "param_subscriptions_to_check"
  result "subscriptions_to_check"
  code <<-EOS
  var subscriptions_to_check = param_subscriptions_to_check
EOS
end

datasource "ds_managed_disks_usage_data" do
  iterate $ds_log_analytics_workspaces
  request do
    auth $auth_azure_log_analytics
    host "api.loganalytics.io"
    path join(["/v1/workspaces/", val(iter_item, "customerId"), "/query"])
    query "query", "Perf | where TimeGenerated > ago(1d) | where ObjectName == \"LogicalDisk\" or ObjectName == \"Logical Disk\" and CounterName == \"Free Megabytes\" and InstanceName == \"/\" | summarize TotalDiskSpaceMB = max(CounterValue), UsedDiskSpaceMB = max(CounterValue) - min(CounterValue), FreespaceMB = min(CounterValue) by Computer, InstanceName"
  end
  result do
    encoding "json"
    collect jmes_path(response, "tables[*]") do
      field "vm_name", jmes_path(col_item, "rows[0][0]")
      field "filesystem", jmes_path(col_item, "rows[0][1]")
      field "total_disk_space_mb", jmes_path(col_item, "rows[0][2]")
      field "used_disk_space_mb", jmes_path(col_item, "rows[0][3]")
      field "free_disk_space_mb", jmes_path(col_item, "rows[0][4]")
    end
  end
end

datasource "ds_oversized_managed_disks" do
  run_script $js_oversized_managed_disks, $ds_managed_disks_usage_data, $param_min_disk_space_pct_used
end

script "js_oversized_managed_disks", type: "javascript" do
  parameters "ds_managed_disks_usage_data", "param_min_disk_space_pct_used"
  result "oversizedManagedDisks"
  code <<-EOS
  var oversizedManagedDisks = []
  _.forEach(ds_managed_disks_usage_data, function(managedDisk) {
    var pctUsed = managedDisk.used_disk_space_mb * 100 / managedDisk.total_disk_space_mb
    managedDisk["used_disk_space_pct"] = pctUsed
    if (pctUsed <= param_min_disk_space_pct_used) {
      oversizedManagedDisks.push(managedDisk)
    }
  })
EOS
end

###############################################################################
# Policy
###############################################################################

policy "pol_azure_rightsize_managed_disks" do
  validate $ds_oversized_managed_disks do
    summary_template "There are {{ len data }} oversized Azure Managed Disks"
    check eq(size(data), 0)
    escalate $esc_email
    export do
      resource_level true
      field "id" do
        label "ID"
        path "vm_name"
      end
      field "vm_name" do
        label "Virtual Machine Name"
      end

      field "total_disk_space_mb" do
        label "Total disk space in megabytes"
      end

      field "used_disk_space_mb" do
        label "Used disk space in megabytes"
      end

      field "free_disk_space_mb" do
        label "Free disk space in megabytes"
      end

      field "used_disk_space_pct" do
        label "Used disk space percentage"
      end
    end
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "esc_email" do
  automatic true
  label "Send Email"
  description "Send incident email."
  email $param_email
end

###############################################################################
# Cloud Workflow
###############################################################################
