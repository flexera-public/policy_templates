name "Reserved Instances Coverage"
rs_pt_ver 20180301
type "policy"
short_description "A policy that sends email notifications on reserved instance coverage"
long_description "Version 0.1"
severity "medium"
category "Cost"

##################
# User inputs    #
##################

parameter "param_email" do
  category "Contact"
  label "Email addresses (separate with commas)"
  type "string"
  allowed_pattern /^([a-zA-Z0-9-_.]+[@]+[a-zA-Z0-9-_.]+[.]+[a-zA-Z0-9-_]+,*|)+$/
end

parameter "param_service" do
 category "Service"
 label "AWS Service"
 type "string"
 allowed_values "Amazon Elastic Compute Cloud - Compute", "Amazon ElastiCache", "Amazon Redshift","Amazon Relational Database Service"
 default "Amazon Elastic Compute Cloud - Compute"
end

parameter "param_historical_number_of_days_in_past" do
  type "number"
  label "Number of days in the past to view RI Coverage"
  allowed_values "7", "14","30", "90", "180", "365"
  default "7"
end

parameter "param_utilization" do
  category "RI"
  label "Utilization"
  type "number"
  default "100"
end

auth "aws", type: "aws" 

datasource "ds_reservations_coverage" do
  request do
    auth $aws
    # https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-explorer-api.html
    host "ce.us-east-1.amazonaws.com"
    verb "POST"
    https true,
    href: "/",
    headers: {
      "X-Amz-Target":"AWSCostExplorerService.GetReservationCoverage",
      "Content-Type":"application/x-amz-json-1.1",
      "content-type": "application/x-amz-json-1.1",
      "content_type": "application/x-amz-json-1.1"
    }
    body: {
      "Start":"2018-04-01",
      "End":"2018-04-30"
    }
  end
  result do
    encoding "json"
    collect jmes_path(response,"[*]") do
      field "total", jmes_path(col_item,"Total")
      field "coveragesbytime", jmes_path(col_item,"CoveragesByTime")
      field "total_coverage_hours_percentage", jmes_path(col_item, "Total.CoverageHoursPercentage.CoverageHoursPercentage")
    end
  end
end

escalation "alert" do
  email $param_email
end

policy "pol_ri_coverage" do
  validate_each $ds_reservations_coverage do
    summary_template "Reserved instances coverage."
    detail_template <<-EOS
# Reserved Instance Coverage

| Organization Name | CoverageHoursPercentage | OnDemandHours | ReservedHours | TotalRunningHours |
| ----------------- | ----------------------- | ------------- | ------------- | ----------------- |
{{ range data }}
| {{rs_org_name}} | {{
* Region: {{.region}}
* Instance Type: {{.instance_type}}
* Instance Count: {{.instance_count}}
* End Time: {{.end_datetime}}
----------------------------
{{ end }}
EOS

  escalate $alert
  #check lt(to_n(val(item,"utilization_percentage")),$param_utilization)
  check lt($param_utilization,$param_utilization)
  end
end