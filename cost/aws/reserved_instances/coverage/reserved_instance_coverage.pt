name "Reserved Instances Coverage"
rs_pt_ver 20180301
type "policy"
short_description "A policy that sends email notifications on reserved instance coverage"
long_description "Version 0.1"
severity "medium"
category "Cost"

##################
# User inputs    #
##################

parameter "param_email" do
  category "Contact"
  label "Email addresses (separate with commas)"
  type "string"
  allowed_pattern /^([a-zA-Z0-9-_.]+[@]+[a-zA-Z0-9-_.]+[.]+[a-zA-Z0-9-_]+,*|)+$/
end

parameter "param_service" do
 category "Service"
 label "AWS Service"
 type "string"
 allowed_values "Amazon Elastic Compute Cloud - Compute", "Amazon ElastiCache", "Amazon Redshift","Amazon Relational Database Service"
 default "Amazon Elastic Compute Cloud - Compute"
end

parameter "param_historical_number_of_days_in_past" do
  type "string"
  label "Number of days in the past to view RI Coverage"
  allowed_values "7", "14","30", "90", "180", "365"
  default "7"
end

#auth "aws", type: "aws"
auth "aws", type: "aws" do
  version "4"
  service "ec2"
  region "us-east-1"
  access_key cred("AWS_ACCESS_KEY_ID")
  secret_key cred("AWS_SECRET_ACCESS_KEY")
end

# https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-explorer-api.html
datasource "ds_reservations_coverage" do
  request do
    auth $aws
    verb "POST"
    host "ce.us-east-1.amazonaws.com"
    path "/"
    header "X-Amz-Target", "AWSInsightsIndexService.GetReservationCoverage"
    header "content-type", "application/x-amz-json-1.1"
    body_field "TimePeriod.Start", "2018-04-01"
    body_field "TimePeriod.End",  "2018-04-30"
  end
  result do
    encoding "json"
    collect jmes_path(response,"Total") do
      field "total_coverage_hours_percentage", jmes_path(col_item, "CoverageHours.CoverageHoursPercentage")
      field "total_on_demand_hours", jmes_path(col_item, "CoverageHours.OnDemandHours")
      field "total_reserved_hours", jmes_path(col_item, "CoverageHours.ReservedHours")
      field "total_running_hours",  jmes_path(col_item, "CoverageHours.TotalRunningHours")
    end
  end
end

escalation "alert" do
  email $param_email
end

policy "pol_ri_coverage" do
  validate_each $ds_reservations_coverage do
    summary_template "Reserved instances coverage."
    detail_template <<-EOS
# Reserved Instance Coverage

| Organization Name | CoverageHoursPercentage | OnDemandHours | ReservedHours | TotalRunningHours |
| ----------------- | ----------------------- | ------------- | ------------- | ----------------- |
{{ range data -}}
| {{rs_org_name}} | {{ .total_coverage_hours_percentage }} | {{.total_on_demand_hours}} | {{.total_reserved_hours}} | {{.total_running_hours}} |
{{ end -}}
EOS

  escalate $alert
  check gt(0,0)
  end
end