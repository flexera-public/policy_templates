name "AWS Native Utilization"
rs_pt_ver 20180301
type "policy"
short_description "Checks for buckets that are open to everyone. See the [README](https://github.com/rightscale/policy_templates/tree/master/security/storage/aws/public_buckets) and [docs.rightscale.com/policies](http://docs.rightscale.com/policies/) to learn more."
long_description "Version: 1.0"
severity "low"
category "Cost"

###############################################################################
# Permissions
###############################################################################

permission "perm_read_creds" do
  actions   "rs_cm.show_sensitive","rs_cm.index_sensitive"
  resources "rs_cm.credentials"
end

###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  label "Email addresses of the recipients you wish to notify"
end

###############################################################################
# Authentication
###############################################################################

auth "monitoring_us_west_2", type: "aws" do
  version 4
  service 'monitoring'
  region 'us-west-2'
  access_key cred('AWS_ACCESS_KEY_ID')
  secret_key cred('AWS_SECRET_ACCESS_KEY')
end

resources "clouds", type: "rs_cm.clouds" do
  filter do
    name "EC2 us-west-2"
  end
end

resources "instances", type: "rs_cm.instances" do
  iterate @clouds
  cloud_href href(iter_item)
  filter do
    state ne:["inactive"]
  end
end
###############################################################################
# Datasources
###############################################################################

datasource "ds_instances" do
  iterate @instances
  field "id", val(iter_item, "resource_uid")
  field "name", val(iter_item, "name")
end

datasource "ds_cloudwatch_cpu_maximum" do
  iterate $ds_instances
  request do
    auth $monitoring_us_west_2
    host "monitoring.us-west-2.amazonaws.com"
    verb "GET"
    path "/"
    header "User-Agent", "RS Policies"
    header "Content-Type", "application/json"
    header "x-amz-target", "GraniteServiceVersion20100801.GetMetricStatistics"
    header "Accept", "application/json"
    header "Content-Encoding", "amz-1.0"
    query 'Action', 'GetMetricStatistics'
    query 'Version', '2010-08-01'
    query 'Namespace', 'AWS/EC2'
    query 'MetricName', 'CPUUtilization'
    query 'Dimensions.member.1.Name', 'InstanceId'
    query 'Dimensions.member.1.Value', val(iter_item,"id")
    query 'StartTime', "2019-04-15T00:00:00.000Z"
    query 'EndTime', "2019-04-15T23:59:59.999Z"
    query 'Period', "86400"
    query 'Statistics.member.1', 'Maximum'
    query 'Statistics.member.2', 'Average'
    query 'Statistics.member.3', 'Minimum'
  end
  result do
    encoding "json"
    collect jmes_path(response, "GetMetricStatisticsResponse.GetMetricStatisticsResult.Datapoints[*]") do
      field "name",  val(iter_item,"name")
      field "id", val(iter_item, "id")
      field "unit", jmes_path(col_item,"Unit")
      field "maximum", jmes_path(col_item, "Maximum")
      field "minimum", jmes_path(col_item, "Minimum")
      field "average", jmes_path(col_item, "Average")
    end
  end
end

###############################################################################
# Policy
###############################################################################

policy "pol_utilization" do
  validate_each $ds_cloudwatch_cpu_maximum do
    summary_template "{{ rs_project_name }} (Account ID: {{ rs_project_id }}): {{ len data }} rows with cheaper data"
    detail_template <<-EOS
# AWS CPU Utilization
| Name | Resource ID | Unit | Maximum | Minimum | Average |
| ---- | ----------- | ---- | ------- | ------- | ------- |
{{ range data -}}
| {{ .name }} | {{ .id }} | {{ .unit }} | {{ .maximum }} | {{.minimum}} | {{ .average }} |
{{ end -}}
___
###### Policy Applied in Account: {{ rs_project_name }} (Account ID: {{ rs_project_id }}) within Org: {{ rs_org_name }} (Org ID: {{ rs_org_id }})
EOS
    check eq(0,1)
    escalate $email
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "email" do
  email $param_email
end

###############################################################################
# Cloud Workflow
###############################################################################

define sys_log($subject, $detail) do
  if $$debug
    rs_cm.audit_entries.create(
      notify: "None",
      audit_entry: {
        auditee_href: @@account,
        summary: $subject,
        detail: $detail
      }
    )
  end
end