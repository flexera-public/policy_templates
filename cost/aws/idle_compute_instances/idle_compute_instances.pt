name "AWS Idle Compute Instances (Batch with Cost)"
rs_pt_ver 20180301
type "policy"
short_description "Check for instances that are idle for the last 30 days and terminates them after approval. See the [README](https://github.com/flexera/policy_templates/tree/master/cost/aws/idle_compute_instances/) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
severity "low"
category "Experimental"
default_frequency "daily"
info(
  version: "2.0",
  provider: "AWS",
  service: "EC2",
  policy_set: "Idle Compute Instances"
)

###############################################################################
# Parameters
###############################################################################

parameter "param_allowed_regions" do
  type "list"
  label "Allowed Regions"
  allowed_pattern /^([a-zA-Z-_]+-[a-zA-Z0-9-_]+-[0-9-_]+,*|)+$/
  description "A list of allowed regions. See the README for more details"
  default []
end

parameter "param_email" do
  type "list"
  label "Email addresses to notify"
  description "Email addresses of the recipients you wish to notify when new incidents are created"
end

parameter "param_aws_sts_account_number" do
  type "string"
  label "Account Number"
  description "The account number for AWS STS Cross Account Roles."
  default ""
end
parameter "param_avg_cpu" do
  type "number"
  label "Average used CPU percentage"
  description "Set to -1 to ignore CPU utilization"
  default -1
  min_value -1
  max_value 100
end

parameter "param_avg_used_memory" do
  type "number"
  label "Average used memory percentage"
  description "Set to -1 to ignore memory utilization"
  default -1
  min_value -1
  max_value 100
end

parameter "param_exclusion_tag_key" do
  category "User Inputs"
  label "Exclusion Tag Key:Value"
  description "Cloud native tag to ignore instances. Format: Key:Value"
  type "string"
  allowed_pattern /(^$)|([\w]?)+\:([\w]?)+/
  default ""
end

parameter "param_automatic_action" do
  type "list"
  label "Automatic Actions"
  description "When this value is set, this policy will automatically take the selected action(s)"
  allowed_values ["Terminate Instances"]
  default []
end

parameter "param_log_to_cm_audit_entries" do
  type "string"
  label "Log to CM Audit Entries"
  description "Boolean for whether or not to log any debugging information from actions to CM Audit Entries, this should be left set to No on Flexera EU"
  default "No"
  allowed_values "Yes", "No"
end

parameter "param_query_blocks" do
  type "number"
  label "CloudWatch Query Block Size"
  description "Number of AWS instances to pull data for in a single CloudWatch query. Default setting of 500 recommended."
  default 500
  min_value 1
  max_value 500
end

###############################################################################
# Authentication
###############################################################################

#authenticate with AWS
credentials "auth_aws" do
  schemes "aws","aws_sts"
  label "AWS"
  description "Select the AWS Credential from the list"
  tags "provider=aws"
  aws_account_number $param_aws_sts_account_number
end

auth "auth_rs", type: "rightscale"

###############################################################################
# Datasources
###############################################################################

datasource "ds_get_caller_identity" do
  request do
    auth $auth_aws
    verb "GET"
    host "sts.amazonaws.com"
    path "/"
    header "User-Agent", "RS Policies"
    query "Action", "GetCallerIdentity"
    query "Version", "2011-06-15"
  end
  result do
    encoding "xml"
    collect xpath(response, "//GetCallerIdentityResponse/GetCallerIdentityResult") do
      field "account",xpath(col_item, "Account")
    end
  end
end

#Get list of enabled regions for an account
datasource "ds_regions_list" do
  request do
    auth $auth_aws
    verb "GET"
    host "ec2.amazonaws.com"
    path "/"
    query "Action", "DescribeRegions"
    query "Version", "2016-11-15"
  end
  result do
    encoding "xml"
    collect xpath(response, "//DescribeRegionsResponse/regionInfo/item", "array") do
      field "region", xpath(col_item, "regionName")
    end
  end
end

# Get only SCP enabled regions
datasource "ds_regions" do
  run_script $js_regions, $param_allowed_regions, $ds_regions_list
end

datasource "ds_instances_set" do
  iterate $ds_regions
  request do
    auth $auth_aws
    host join(['ec2.', val(iter_item, 'region'), '.amazonaws.com'])
    path '/'
    header 'User-Agent', 'RS Policies'
    header 'Content-Type', 'text/xml'
    query 'Action', 'DescribeInstances'
    query 'Version', '2016-11-15'
    query 'Filter.1.Name', 'instance-state-name'
    query 'Filter.1.Value.1', 'running'
  end
  result do
    encoding "xml"
    collect xpath(response, "//DescribeInstancesResponse/reservationSet/item", "array") do
      field "instances_set" do
        collect xpath(col_item,"instancesSet/item","array") do
          field "region",val(iter_item, "region")
          field "instanceId", xpath(col_item,"instanceId")
          field "imageId", xpath(col_item,"imageId")
          field "resourceType", xpath(col_item, "instanceType")
          field "platform", xpath(col_item, "platform")
          field "privateDnsName", xpath(col_item, "privateDnsName")
          field "tags" do
            collect xpath(col_item,"tagSet/item","array") do
              field "key", xpath(col_item, "key")
              field "value", xpath(col_item, "value")
            end
          end
        end
      end
    end
  end
end

datasource "ds_instances" do
  run_script $js_instances, $ds_instances_set, $param_exclusion_tag_key
end

datasource "ds_instances_requests" do
  run_script $js_instances_requests, $ds_instances, $param_query_blocks
end

datasource "ds_cloudwatch_cpu_usage" do
  iterate $ds_instances_requests
  request do
    run_script $js_cloudwatch_cpu_usage, val(iter_item, "region"), val(iter_item, "body_string")
  end
  result do
    encoding "json"
    collect jmes_path(response, "MetricDataResults[*]") do
      field "region", val(iter_item, "region")
      field "id", jmes_path(col_item, "Id")
      field "label", jmes_path(col_item, "Label")
      field "values", jmes_path(col_item, "Values")
    end
  end
end

datasource "ds_merged_metrics_cpu" do
  run_script $js_merged_metrics_cpu, $ds_cloudwatch_cpu_usage, $ds_instances, $param_avg_cpu
end

datasource "ds_instances_memory_list" do
  run_script $js_instances_memory_list, $ds_merged_metrics_cpu, $param_avg_used_memory
end

datasource "ds_cloudwatch_mem_usage" do
  iterate $ds_instances_memory_list
  request do
    run_script $js_cloudwatch_mem_usage, val(iter_item, "region"), val(iter_item, "instanceId"), val(iter_item,"privateDnsName")
  end
  result do
    encoding "json"
    collect jmes_path(response,"GetMetricStatisticsResponse.GetMetricStatisticsResult.Datapoints[*]") do
      field "region", val(iter_item, "region")
      field "id", val(iter_item, "instanceId")
      field "privateDnsName", val(iter_item, "privateDnsName")
      field "tags", val(iter_item, "tags")
      field "mem_unit", jmes_path(col_item,"Unit")
      field "mem_maximum", jmes_path(col_item, "Maximum")
      field "mem_minimum", jmes_path(col_item, "Minimum")
      field "mem_average", jmes_path(col_item, "Average")
    end
  end
end

datasource "ds_cloudwatch_windows_mem_usage" do
  iterate $ds_instances_memory_list
  request do
    run_script $js_cloudwatch_windows_memory_usage, val(iter_item, "region"), val(iter_item, "instanceId"), val(iter_item, "imageId"), val(iter_item, "resourceType")
  end
  result do
    encoding "json"
    collect jmes_path(response,"GetMetricStatisticsResponse.GetMetricStatisticsResult.Datapoints[*]") do
      field "region", val(iter_item, "region")
      field "id", val(iter_item, "instanceId")
      field "privateDnsName", val(iter_item, "privateDnsName")
      field "tags", val(iter_item, "tags")
      field "mem_unit", jmes_path(col_item,"Unit")
      field "mem_maximum", jmes_path(col_item, "Maximum")
      field "mem_minimum", jmes_path(col_item, "Minimum")
      field "mem_average", jmes_path(col_item, "Average")
    end
  end
end

datasource "ds_merged_metrics_complete" do
  run_script $js_merged_metrics_complete, $ds_merged_metrics_cpu, $ds_cloudwatch_mem_usage, $ds_cloudwatch_windows_mem_usage, $param_avg_used_memory
end

datasource "ds_merged_metrics_filtered" do
  run_script $js_merged_metrics_filtered, $ds_merged_metrics_complete, $param_avg_cpu, $param_avg_used_memory
end

datasource "ds_currency_reference" do
  request do
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/master/cost/scheduled_reports/currency_reference.json"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_currency_code" do
  request do
    auth $auth_rs
    host rs_optima_host
    path join(["/bill-analysis/orgs/",rs_org_id,"/settings/currency_code"])
    header "Api-Version", "0.1"
    header "User-Agent", "RS Policies"
    ignore_status [403]
  end
  result do
    encoding "json"
    field "id", jmes_path(response,"id")
    field "value", jmes_path(response,"value")
  end
end

datasource "ds_billing_centers" do
  request do
    auth $auth_rs
    host rs_optima_host
    path join(["/analytics/orgs/",rs_org_id,"/billing_centers"])
    header "Api-Version", "1.0"
    header "User-Agent", "RS Policies"
    query "view", "allocation_table"
    ignore_status [403]
  end
  result do
    encoding "json"
    collect jmes_path(response,"[*]") do
      field "href", jmes_path(col_item,"href")
      field "id", jmes_path(col_item,"id")
      field "name", jmes_path(col_item,"name")
      field "parent_id", jmes_path(col_item,"parent_id")
    end
  end
end

datasource "ds_top_level_billing_centers" do
  run_script $js_top_level_bc, $ds_billing_centers
end

datasource "ds_instances_costs" do
  request do
    run_script $js_get_costs, $ds_get_caller_identity, $ds_top_level_billing_centers, rs_org_id, rs_optima_host
  end
  result do
    encoding "json"
    collect jmes_path(response,"rows[*]") do
      field "resource_id", jmes_path(col_item,"dimensions.resource_id")
      field "vendor_account", jmes_path(col_item,"dimensions.vendor_account")
      field "vendor_account_name", jmes_path(col_item,"dimensions.vendor_account_name")
      field "cost_nonamortized_unblended_adj", jmes_path(col_item,"metrics.cost_nonamortized_unblended_adj")
    end
  end
end

datasource "ds_final_list" do
  run_script $js_final_list, $ds_merged_metrics_filtered, $ds_instances_costs, $ds_get_caller_identity, $ds_currency_reference, $ds_currency_code
end

###############################################################################
# Scripts
###############################################################################

script "js_regions", type:"javascript" do
  parameters "user_entered_regions", "all_regions"
  result "regions"
  code <<-EOS
    if (_.isEmpty(user_entered_regions)) {
      regions = all_regions
    } else {
      //Filter unique regions
      var uniqueRegions = _.uniq(user_entered_regions);
      var all_regions_list = [];
      all_regions.forEach(function(all_region){
        all_regions_list.push(all_region.region)
      })

      //Filter valid regions
      var valid_regions = [];
      _.map(uniqueRegions, function(uniqueRegion){
        if(all_regions_list.indexOf(uniqueRegion) > -1){
          valid_regions.push({"region": uniqueRegion})
        }
      })

      //Throw an error if no valid regions found
      if (_.isEmpty(valid_regions)) {
        regions = all_regions;
      }else{
        regions = valid_regions
      }
    }
  EOS
end

script "js_instances", type: "javascript" do
  result "results"
  parameters "ds_instance_set", "param_exclusion_tag_key"
  code <<-EOS
  var tag_key = param_exclusion_tag_key.split(':')[0]
  var tag_value = param_exclusion_tag_key.split(':')[1]
  var results = []

  _.each(ds_instance_set, function(ds_item) {
    _.each(ds_item['instances_set'], function(instance) {
      var tags = instance.tags

      if (!(_.contains(_.pluck(tags,'key'), tag_key) && _.contains(_.pluck(tags,'value'), tag_value))) {
        results.push({
          "region": instance.region,
          "instanceId": instance.instanceId,
          "imageId": instance.imageId,
          "resourceType": instance.resourceType,
          "platform": instance.platform,
          "privateDnsName": instance.privateDnsName,
          "tags": instance.tags
        })
      }
    })
  })
EOS
end

script "js_instances_requests", type: "javascript" do
  result "result"
  parameters "ds_instances", "param_query_blocks"
  code <<-EOS
    queries = {}

    _.each(ds_instances, function(instance) {
      query_avg =  {
        "Id": instance['instanceId'].replace('-', '_') + "_avg",
        "MetricStat": {
          "Metric": {
            "Namespace": "AWS/EC2",
            "MetricName": "CPUUtilization",
            "Dimensions": [
              { "Name": "InstanceId", "Value": instance['instanceId'] }
            ]
          },
          "Period": 2592000,
          "Stat": "Average"
        },
        "ReturnData": true
      }

      query_max =  {
        "Id": instance['instanceId'].replace('-', '_') + "_max",
        "MetricStat": {
          "Metric": {
            "Namespace": "AWS/EC2",
            "MetricName": "CPUUtilization",
            "Dimensions": [
              { "Name": "InstanceId", "Value": instance['instanceId'] }
            ]
          },
          "Period": 2592000,
          "Stat": "Maximum"
        },
        "ReturnData": true
      }

      query_min =  {
        "Id": instance['instanceId'].replace('-', '_') + "_min",
        "MetricStat": {
          "Metric": {
            "Namespace": "AWS/EC2",
            "MetricName": "CPUUtilization",
            "Dimensions": [
              { "Name": "InstanceId", "Value": instance['instanceId'] }
            ]
          },
          "Period": 2592000,
          "Stat": "Minimum"
        },
        "ReturnData": true
      }

      if (queries[instance['region']] == undefined || queries[instance['region']] == null) {
        queries[instance['region']] = []
      }

      queries[instance['region']].push(query_avg)
      queries[instance['region']].push(query_max)
      queries[instance['region']].push(query_min)
    })

    result = []
    end_date = parseInt(new Date().getTime() / 1000)
    start_date = parseInt(new Date(new Date().setDate(new Date().getDate() - 30)).getTime() / 1000)

    _.each(Object.keys(queries), function(region) {
      for (i = 0; i < queries[region].length; i += param_query_blocks) {
        chunk = queries[region].slice(i, i + param_query_blocks)

        result.push({
          'body': { "StartTime": start_date, "EndTime": end_date, "MetricDataQueries": chunk },
          'body_string': JSON.stringify({ "StartTime": start_date, "EndTime": end_date, "MetricDataQueries": chunk }),
          'region': region
        })
      }
    })
EOS
end

script "js_cloudwatch_cpu_usage", type: "javascript" do
  result "results"
  parameters "region", "body_string"
  code <<-EOS
  // Slow down rate of requests to prevent throttling
  var now = new Date().getTime();
  var sleepDuration = 10000
  while(new Date().getTime() < now + sleepDuration){ /* Do nothing */ }

  results = {
    "auth": "auth_aws",
    "host": 'monitoring.' + region + '.amazonaws.com',
    "verb": "POST",
    "path": "/",
    "headers": {
      "User-Agent": "RS Policies",
      "Content-Type": "application/json",
      "x-amz-target": "GraniteServiceVersion20100801.GetMetricData",
      "Accept": "application/json",
      "Content-Encoding": "amz-1.0"
    }
    "query_params": {
      'Action': 'GetMetricData',
      'Version': '2010-08-01'
    },
    body: body_string
  }
EOS
end

script "js_merged_metrics_cpu", type: "javascript" do
  result "result"
  parameters "ds_cloudwatch_cpu_usage", "ds_instances", "param_avg_cpu"
  code <<-EOS
  result = []

  // Sort data into regions to avoid comparing entire data sets
  region_list = []
  instance_regions = {}
  cloudwatch_regions = {}

  _.each(ds_instances, function(item) {
    if (instance_regions[item['region']] == undefined || instance_regions[item['region']] == null) {
      instance_regions[item['region']] = []
    }

    instance_regions[item['region']].push(item)

    region_found = false

    _.each(region_list, function(region) {
      if (region == item['region']) {
        region_found = true
      }
    })

    if (region_found == false) {
      region_list.push(item['region'])
    }
  })

  _.each(ds_cloudwatch_cpu_usage, function(item) {
    if (cloudwatch_regions[item['region']] == undefined || cloudwatch_regions[item['region']] == null) {
      cloudwatch_regions[item['region']] = []
    }

    cloudwatch_regions[item['region']].push(item)
  })

  _.each(region_list, function(region) {
    _.each(instance_regions[region], function(instance) {
      cpu_maximum = -1
      cpu_minimum = -1
      cpu_average = -1

      _.each(cloudwatch_regions[region], function(entry) {
        if (entry['id'] == instance['instanceId'].replace('-', '_') + '_max') {
          cpu_maximum = parseFloat(entry['values'][0]).toFixed(2)
        }

        if (entry['id'] == instance['instanceId'].replace('-', '_') + '_min') {
          cpu_minimum = parseFloat(entry['values'][0]).toFixed(2)
        }

        if (entry['id'] == instance['instanceId'].replace('-', '_') + '_avg') {
          cpu_average = parseFloat(entry['values'][0]).toFixed(2)
        }
      })

      result.push({
        "region": instance['region'],
        "id": instance['instanceId'],
        "platform": instance['platform'],
        "privateDnsName": instance['privateDnsName'],
        "hostname": instance['privateDnsName'].split('.')[0],
        "tags": instance['tags'],
        "imageId": instance['imageId'],
        "resourceType": instance['resourceType'],
        "cpu_maximum": cpu_maximum,
        "cpu_minimum": cpu_minimum,
        "cpu_average": cpu_average,
        "savings": 0.0
      })
    })
  })
EOS
end

script "js_instances_memory_list", type: "javascript" do
  result "result"
  parameters "ds_merged_metrics_cpu", "param_avg_used_memory"
  code <<-EOS
  if (param_avg_used_memory == -1) {
    result = []
  } else {
    result = ds_merged_metrics_cpu
  }
EOS
end

script "js_merged_metrics_complete", type: "javascript" do
  result "result"
  parameters "ds_merged_metrics_cpu", "ds_cloudwatch_mem_usage", "ds_cloudwatch_windows_mem_usage", "param_avg_used_memory"
  code <<-EOS
  result = []

  _.each(ds_merged_metrics_cpu, function(instance) {
    instance['mem_maximum'] = -1
    instance['mem_minimum'] = -1
    instance['mem_average'] = -1

    if (param_avg_used_memory != -1) {
      _.each(ds_cloudwatch_mem_usage, function(mem_instance) {
        if (instance['id'] == mem_instance['id']) {
          if (mem_instance['mem_maximum'] != null && mem_instance['mem_maximum'] != undefined) {
            instance['mem_maximum'] = parseFloat(mem_instance['mem_maximum']).toFixed(2)
            instance['mem_minimum'] = parseFloat(mem_instance['mem_minimum']).toFixed(2)
            instance['mem_average'] = parseFloat(mem_instance['mem_average']).toFixed(2)
          }
        }
      })

      _.each(ds_cloudwatch_windows_mem_usage, function(mem_instance) {
        if (instance['id'] == mem_instance['id']) {
          if (mem_instance['mem_maximum'] != null && mem_instance['mem_maximum'] != undefined) {
            instance['mem_maximum'] = parseFloat(mem_instance['mem_maximum']).toFixed(2)
            instance['mem_minimum'] = parseFloat(mem_instance['mem_minimum']).toFixed(2)
            instance['mem_average'] = parseFloat(mem_instance['mem_average']).toFixed(2)
          }
        }
      })
    }

    result.push(instance)
  })
EOS
end

script "js_merged_metrics_filtered", type: "javascript" do
  result "result"
  parameters "ds_merged_metrics", "ds_cloudwatch_mem_usage", "param_avg_cpu", "param_avg_used_memory"
  code <<-EOS
  result = []

  _.each(ds_merged_metrics, function(instance) {
    bad_instance = false

    if (param_avg_cpu >= instance['cpu_average'] && instance['cpu_average'] != -1) {
      bad_instance = true
    }

    if (param_avg_used_memory >= instance['mem_average'] && instance['mem_average'] != -1) {
      bad_instance = true
    }

    if (bad_instance) {
      result.push(instance)
    }
  })
EOS
end


script "js_get_costs", type:"javascript" do
  parameters "ds_get_caller_identity", "billing_centers", "org", "optima_host"
  result "request"
  code <<-EOS
    // returns date formatted as string: YYYY-mm-dd
    function getFormattedDailyDate(date) {
      var year = date.getFullYear();
      var month = (1 + date.getMonth()).toString();
      month = month.length > 1 ? month : '0' + month;
      var day = date.getDate().toString();
      day = day.length > 1 ? day : '0' + day;
      return year + '-' + month + '-' + day;
    }

    var start_date = getFormattedDailyDate(new Date(new Date().setDate(new Date().getDate() - 3)));
    var end_date = getFormattedDailyDate(new Date(new Date().setDate(new Date().getDate() - 2)));

    var request = {
      auth: "auth_rs",
      host: optima_host,
      verb: "POST",
      path: "/bill-analysis/orgs/" + org + "/costs/select",
      body_fields: {
        "dimensions": ["resource_id"],
        "granularity": "day",
        "start_at": start_date,
        "end_at": end_date,
        "metrics": ["cost_nonamortized_unblended_adj"],
        "billing_center_ids": _.compact(_.map(billing_centers, function(value){ return value.id})),
        "limit": 100000,
        "filter": {
          "expressions": [
            {
              "dimension": "service",
              "type": "equal",
              "value": "AmazonEC2"
            },
            {
              "dimension": "resource_type",
              "type": "equal",
              "value": "Compute Instance"
            },
            {
              "dimension": "vendor_account",
              "type": "equal",
              "value": ds_get_caller_identity[0]['account']
            }
          ],
          "type": "and"
        }
      },
      headers: {
        "User-Agent": "RS Policies",
        "Api-Version": "1.0"
      },
      ignore_status: [400]
    }
  EOS
end

script "js_final_list", type:"javascript" do
  parameters "ds_merged_metrics", "ds_instances_costs", "ds_get_caller_identity", "ds_currency_reference", "ds_currency_code"
  result "result"
  code <<-EOS
  result = {
    "idle_instances": [],
    "message": ""
  }

  savingsCurrency = ""
  separator = ""

  if (ds_currency_code['value'] !== undefined) {
    if (ds_currency_reference[ds_currency_code['value']] !== undefined) {
      savingsCurrency = ds_currency_reference[ds_currency_code['value']]['symbol']

      if(ds_currency_reference[ds_currency_code['value']]['t_separator'] !== undefined) {
        separator = ds_currency_reference[ds_currency_code['value']]['t_separator']
      }
    }
  } else {
    var savingsCurrency = "$"
    var separator = ","
  }

  cost_data_found = false
  total_savings = 0

  _.each(ds_merged_metrics, function(instance) {
    instance['accountID'] = ds_get_caller_identity[0]['account']
    instance['savings'] = null
    instance['savingsCurrency'] = savingsCurrency
    instance['resourceID'] = instance['id']
    instance['service'] = 'EC2'

    _.each(ds_instances_costs, function(cost) {
      if (instance['id'] == cost['resource_id']) {
        instance['savings'] = parseFloat(cost['cost_nonamortized_unblended_adj'] * 30).toFixed(2)
        total_savings += instance['savings']
      }
    })

    if (instance['savings'] != null) {
      cost_data_found = true
    }

    result['idle_instances'].push(instance)
  })

  if (cost_data_found) {
    pretty_savings = savingsCurrency + formatNumber(total_savings.toFixed(2), separator)
    result['message'] = "The total estimated monthly savings are " + pretty_savings + "."
  } else {
    result['message'] = "Unable to calculate savings. Either the Flexera Optima system does not have any data to calculate savings for these resources, or you do not have the minimum required role of billing_center_viewer to view the cost data."
  }
EOS
end

###############################################################################
# Policy
###############################################################################

policy "pol_utilization" do
  validate $ds_final_list do
    summary_template "AWS Account ID: {{with index data.idle_instances 0}}{{ .accountID }}{{end}} - {{ len data.idle_instances}} rows containing AWS instance CloudWatch utilization data"
    detail_template <<-EOS
{{data.message}}
EOS
    escalate $email
    escalate $terminate_resources
    check eq(size(val(data, "idle_instances")), 0)
    export "idle_instances" do
      resource_level true
      field "accountID" do
        label "Account Id"
      end
      field "resourceID" do
        label "Resource ID"
      end
      field "region" do
        label "Region"
      end
      field "platform" do
        label "Platform"
      end
      field "hostname" do
        label "Hostname"
      end
      field "savings" do
        label "Estimated Monthly Savings"
      end
      field "savingsCurrency" do
        label "Savings Currency"
      end
      field "privateDnsName" do
        label "Private DNS Name"
      end
      field "cpu_maximum" do
        label "CPU Maximum %"
      end
      field "cpu_minimum" do
        label "CPU Minimum %"
      end
      field "cpu_average" do
        label "CPU Average %"
      end
      field "resourceType" do
        label "Resource Type"
      end
      field "mem_maximum" do
        label "Memory Maximum %"
      end
      field "mem_minimum" do
        label "Memory Minimum %"
      end
      field "mem_average" do
        label "Memory Average %"
      end
      field "tags" do
        label "Tags"
      end
      field "id" do
        label "ID"
        path "resourceID"
      end
      field "service" do
        label "Service"
      end
    end
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "email" do
  automatic true
  label "Send Email"
  description "Send incident email"
  email $param_email
end

escalation "terminate_resources" do
  automatic contains($param_automatic_action, "Terminate Instances")
  label "Terminate Instances"
  description "Approval to terminate all selected instances"
  run "terminate_resources", data, $param_log_to_cm_audit_entries
end

###############################################################################
# Cloud Workflow
###############################################################################

define terminate_resources($data,$param_log_to_cm_audit_entries) return $all_responses do
  $$debug = $param_log_to_cm_audit_entries == "Yes"
  $$log = []
  $all_responses = []
  $syslog_subject = "AWS Idle Compute: "
  call sys_log(join([$syslog_subject, "Identified Instances"]),to_s($data))
  foreach $item in $data do
    $response = http_request(
      auth: $$auth_aws,
      https: true,
      verb: "post",
      href: "/",
      host: "ec2."+$item["region"]+".amazonaws.com",
      query_strings: {
        "Action": "TerminateInstances",
        "Version": "2012-06-01",
        "InstanceId.1": $item["id"]
      }
    )
    $all_responses << $response
  end
  call sys_log(join([$syslog_subject, "Responses"]),to_s($all_responses))
end

define handle_error($response) do
  $status_code = $response["code"]
  $syslog_subject = "AWS Idle Compute Termination Error: "
  call sys_log(join([$syslog_subject, $status_code]),to_s($response))
  $_error_behavior = "skip"
end

define sys_log($subject, $detail) do
  if $$debug
    rs_cm.audit_entries.create(
      notify: "None",
      audit_entry: {
        auditee_href: @@account,
        summary: $subject,
        detail: $detail
      }
    )
  end
end
