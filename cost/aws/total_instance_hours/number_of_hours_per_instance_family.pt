name "AWS - Number of Hours per Instance Family"
rs_pt_ver 20180301
type "policy"
short_description "Number of Hours used for each AWS Instance Family"
long_description ""
severity "low"
category "Cost"
default_frequency "monthly"
info(
  version: "2.0",
  provider: "Flexera Optima",
  service: "",
  policy_set: ""
)

###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  label "Email addresses"
end

parameter "param_region" do
  type "string"
  label "Region"
  description "Select an AWS region. Leave empty for view across all regions"
end

###############################################################################
# Authentication
###############################################################################

#AUTHENTICATE WITH RIGHTSCALE/OPTIMA
credentials "auth_rs" do
  schemes "oauth2"
  label "Flexera_Automation"
  description "Select FlexeraOne OAuth2 credentials"
  tags "provider=flexera"
end

###############################################################################
# Datasources and Scripts
###############################################################################

#GET BILLING CENTERS FOR ORG
datasource "ds_billing_centers" do
  request do
    auth $auth_rs
    host rs_optima_host
    path join(["/analytics/orgs/",rs_org_id,"/billing_centers"])
    header "Api-Version", "1.0"
    header "User-Agent", "RS Policies"
    query "view", "allocation_table"
  end
  result do
    encoding "json"
    collect jmes_path(response,"[*]") do
      field "href", jmes_path(col_item,"href")
      field "id", jmes_path(col_item,"id")
      field "name", jmes_path(col_item,"name")
      field "parent_id", jmes_path(col_item,"parent_id")
      field "ancestor_ids", jmes_path(col_item,"ancestor_ids")
      field "allocation_table", jmes_path(col_item,"allocation_table")
    end
  end  
end
  
#GET TOP-LEVEL BILLING CENTERS
datasource "ds_top_level_billing_centers" do
  run_script $js_top_level_bc, $ds_billing_centers
end
  
script "js_top_level_bc", type: "javascript" do
  parameters "billing_centers"
  result "filtered_billing_centers"
  code <<-EOS
  var filtered_billing_centers =
    _.reject(billing_centers, function(bc){ return bc.parent_id != null })
  EOS
end

#GET USAGE DATA FOR INSTANCE TYPES
datasource "ds_usage_data" do
  request do
    run_script $js_get_usage_data, $ds_top_level_billing_centers, $param_region, rs_org_id, rs_optima_host
  end
  result do
    encoding "json"
    collect jmes_path(response, "rows") do
      field "billing_center_id", jmes_path(col_item,"dimensions.billing_center_id")
      field "instance_type", jmes_path(col_item,"dimensions.instance_type")
      field "usage_unit", jmes_path(col_item,"dimensions.usage_unit")
      field "cost", jmes_path(col_item,"metrics.cost_nonamortized_unblended_adj")
      field "usage_amount", jmes_path(col_item,"metrics.usage_amount")
      field "month", jmes_path(col_item,"timestamp")
    end
  end
end

script "js_get_usage_data", type: "javascript" do
  parameters "top_level_billing_centers", "region", "org_id", "optima_host"
  result "request"
  code <<-EOS 
  //Billing Center IDs into array
  billing_center_ids = []
  _.each(top_level_billing_centers, function(bc){
    billing_center_ids.push(bc.id)
  })

  //Get Start and End dates
  start_date = new Date(), end_date = new Date()
  start_date.setMonth(start_date.getMonth() - 13)
  end_date.setMonth(end_date.getMonth() - 1)

  //get expressions for payload based on region parameter
  expressions = []
  if( region == "" ){ 
    expressions = [
      { "dimension": "category", "type": "equal", "value": "Compute" },
      { "dimension": "resource_type", "type":"equal", "value":"Compute Instance" },
      { "dimension": "vendor", "type":"equal", "value":"AWS" },
      {
        "type": "not",
        "expression": { "dimension": "instance_type", "type": "equal", "value": "None" }
      }
    ]
  } else { 
    expressions = [
      { "dimension": "category", "type": "equal", "value": "Compute" },
      { "dimension": "resource_type", "type":"equal", "value":"Compute Instance" },
      { "dimension": "vendor", "type":"equal", "value":"AWS" },
      { "dimension": "region", "type": "equal", "value": region },
      {
        "type": "not",
        "expression": { "dimension": "instance_type", "type": "equal", "value": "None" }
      }
    ]
  }
  
  //POST JSON payload
  payload = {
    "billing_center_ids": billing_center_ids,
    "filter": {
      "type": "and",
      "expressions": expressions
    },
    "dimensions": [
      "instance_type",
      "usage_unit"
    ],
    "granularity": "month",
    "metrics": [
      "cost_nonamortized_unblended_adj",
      "usage_amount"
    ],
    "end_at": end_date.toLocaleDateString("en-US").split("-")[0] + "-" + end_date.toLocaleDateString("en-US").split("-")[1]
    "start_at": start_date.toLocaleDateString("en-US").split("-")[0] + "-" + start_date.toLocaleDateString("en-US").split("-")[1]
  }

  //Request
  request = {
    auth: "auth_rs",
    host: optima_host,
    path: "/bill-analysis/orgs/" + org_id + "/costs/aggregated",
    verb: "POST",
    body_fields: payload,
    headers: {
      "User-Agent": "RS Policies",
    }
  }
  EOS
end

#GET CSV WITH NORMALIZATION FACTOR UNITS
datasource "ds_nfu_ratio_csv" do
  run_script $js_get_aws_nfu
end

script "js_get_aws_nfu", type: "javascript" do
  result "result"
  code <<-'EOS'
  var result =  { "csv": "Instance Size,Normalization Factor\r\nnano,0.25\r\nmicro,0.5\r\nsmall,1\r\nmedium,2\r\nlarge,4\r\nxlarge,8\r\n2xlarge,16\r\n3xlarge,24\r\n4xlarge,32\r\n6xlarge,48\r\n8xlarge,64\r\n9xlarge,72\r\n10xlarge,80\r\n12xlarge,96\r\n16xlarge,128\r\n18xlarge,144\r\n24xlarge,192\r\n32xlarge,256\r\n56xlarge,448\r\n112xlarge,896"}
  EOS
end


#GROUP INSTANCE TYPES INTO INSTANCE FAMILIES AND CALCULATE INSTANCE HOURS
datasource "ds_instance_hours_per_fam" do
  run_script $js_get_instance_hours_per_fam, $ds_nfu_ratio_csv, $ds_usage_data
end

script "js_get_instance_hours_per_fam", type: "javascript" do
  parameters "nfu_ratios", "usage_data"
  result "result"
  code <<-'EOS'
  result = []

  //Convert NFU csv to json
  nfu_ratio_array = nfu_ratios.csv.toString().split("\r\n")
  nfu_ratios_json = []
  _.each(nfu_ratio_array, function(ratio, i){
    if(i != 0 ){
      nfu_ratios_json.push({
        "instance_size": ratio.split(",")[0],
        "nfu": ratio.split(",")[1]
      })
    }
  })

  //Enrich current data with Instance Family, and then calculate Normalized Instance Hours using NFU
  _.each(usage_data, function(data){
    data["instance_family"] = data.instance_type.split(".")[0]
    _.each(nfu_ratios_json, function(ratio){
      if(data.instance_type.split(".")[1] == ratio.instance_size ){
        data["normalized_instance_hours"] = data.usage_amount * ratio.nfu
      }
    })
  })

  //For each month, sum Instance Hours for each Instance Family
  month = _.pluck( _.uniq(usage_data, function(data){ return data.month }), "month" )
  inst_family = _.pluck( _.uniq(usage_data, function(data){ return data.instance_family }), "instance_family" )

  _.each(month, function(mo){
    _.each(inst_family, function(fam){
      total_inst_hrs = 0
      _.each(usage_data, function(data){
        if(data.month == mo && data.instance_family == fam){
          total_inst_hrs += data.normalized_instance_hours 
        }
      })
      result.push({
        "month": mo,
        "instance_family": fam,
        "total_instance_hours": total_inst_hrs
      })
    })  
  })

  EOS
end

#CHART CREATION
datasource "ds_chart_creation" do
  run_script $js_create_chart_data, $ds_instance_hours_per_fam
end

script "js_create_chart_data", type: "javascript" do
  parameters "inst_hrs_data"
  result "report"
  code <<-EOS

  //Group data by Instance Family
  group_by_inst_fam = 
  _.groupBy(inst_hrs_data, function(data){ return data.instance_family })
  report = inst_hrs_data

  //Create chart axis labels
  chart_axis_labels = 
  ("chxl=1:," + 
    _.uniq(inst_hrs_data, function(data) { return data.month })
    .map(function(data){ return data.month.substring(0,7) })
  ).split(",").join("|")

  //Create legend
  chart_legend = "chdl="
  var i = 0 
  for (var key in group_by_inst_fam) {
    chart_legend += key.replace("&","%26").replace(/ /g,"%20")
    i++
    if (i < _.size(group_by_inst_fam)) { chart_legend += "|" }
  }
  console.log(chart_legend)

  //Create chart dataset
  chart_data = "chd=t:"
  var count_1 = 0
  _.each(group_by_inst_fam, function(o){
    var count_2 = 0
    _.each(o, function(p){
      chart_data = chart_data + p.total_instance_hours
      count_2++
      if (count_2 < _.size(o)){ chart_data = chart_data + "," } 
    })
    count_1++
    if (count_1 < _.size(group_by_inst_fam)){ chart_data = chart_data + "|" }
  })

  //Whole Chart object
  chart = {
    chart_type: "cht=lc",
    chart_size: "chs=900x500",
    chart_data: chart_data,
    chart_title: "chtt=Total%20Instance%20Hours%20Used%20Per%20Instance%20Family",
    chart_image: "chof=.png",  
    chart_label_position: "chdlp=b",
    chart_y_axis: "chxt=y,x",
    chart_y_axis_label: chart_axis_labels,
    chart_line_style: "chls=3|3|3|3|3|3|3|3|3|3|3",
    chart_line_color: "chco=6929c4,9f1853,198038,b28600,1192e8,009d9a,005d5d,007d79",
    chart_data_scale: "chds=a",
    chart_legend: chart_legend,
    chart_legend_size: "chdls=000000,5"
  }

  report[0]["chart_dimensions"] = chart
  EOS
end

###############################################################################
# Escalations
###############################################################################

escalation "esc_instance_hours_report" do
  automatic true
  label "Send Email"
  description "Send incident email"
  email $param_email
end

###############################################################################
# Policy
###############################################################################

policy "pol_inst_hrs_per_inst_fam" do
  validate_each $ds_chart_creation do
    summary_template "AWS - Instance Hours Used per Instance Family (Normalized - past 12 months)"
    detail_template <<-EOS
    # AWS - Instance Hours Used Per Instance Family Report
    ![Instance Hours Used Per Instance Family Chart](https://image-charts.com/chart?{{ with index data 0 }}{{ .chart_dimensions.chart_data }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_size }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_type }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_image }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_title }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_label_position }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_y_axis }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_y_axis_label }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_line_style }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_line_color }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_data_scale }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_legend_size }}{{ end }}&{{ with index data 0 }}{{ .chart_dimensions.chart_legend }}{{ end }}
    )
    EOS
    escalate $esc_instance_hours_report
    check eq(0,1)
    export do
      # no actions so resource_level can be false
      resource_level false
      field "month" do
        label "Month"
      end
      field "instance_family" do
        label "Instance Family"
      end
      field "total_instance_hours" do
        label "Instance Hours Used"
      end
    end
  end
end
