name "Cloud Hash Test"
rs_pt_ver 20180301
short_description "Finds unattached volumes older than specified number of days and reports them."
severity "medium"
category "Cost Management"

resources "clouds", type: "rs_cm.clouds" do
  filter do
    cloud_type ne: ["soft_layer", "cloud_stack", "rackspace_next_gen", "blue_skies","open_stack_v2","uca","open_stack_v3"]
    #cloud_type eq: ["azure", "azure_v2"]
  end
end

datasource "ds_clouds" do
	iterate @clouds
	field "href", href(iter_item)
	field "cloud_type", val(iter_item, "cloud_type")
end

datasource "ds_unattached_volumes" do
  run_script $js_unattached_volumes, $ds_clouds
end


# Find unattached volumes and also calculate their age.
# The age calculation is used to find old ones later on and also to inform the user of the ages of flagged volumes.
script "js_unattached_volumes", type: "javascript" do
  parameters "ds_clouds"
  result "unattached_volumes"
  code <<-EOS
// This is the list of unattached volumes.
var unattached_volumes = [];

// Used for volume type discovery below
// Build a cloud href -> type hash
var cloud_hash = {"goo":"foo"}
for (var i = 0; i < ds_clouds.length; i++) {
  var ds_cloud = ds_clouds[i]
  var cloud_href = ds_cloud["href"]
  var cloud_type = ds_cloud["cloud_type"]
  cloud_hash[cloud_href] = cloud_type
}

var cloud_hash_dump = JSON.stringify(cloud_hash)
//var cloud_hash_dump = JSON.stringify(ds_clouds)
unattached_volumes.push({"cloud_hash":cloud_hash_dump} );
EOS
end
	
policy "pol_unattached_volumes" do
    validate_each $ds_unattached_volumes do
	# Go through the unattached volumes that were found by the script-based datasource above
	# and check if not older than specified number of days.
	# If the check fails, it'll flag the volume
	#check le(val(item, "age"), $param_days_old)
	check eq(0,1)

	#escalate $esc_unattached_volumes

	summary_template "Unattached Volumes"

    	detail_template <<-EOS
Unattached Volume Report for Account: {{ rs_project_name }} (ID: {{ rs_project_id }})
The following unattached volumes have exceeded the specified age of: {{ parameters.param_days_old }} days old
{{ range data }}
Cloud Hash: {{ .cloud_hash}}
{{ end }}
EOS
    end
end


escalation "esc_unattached_volumes" do
  email $param_email
end

