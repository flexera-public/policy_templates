name "Master Org Cost Policy"
rs_pt_ver 20180301
type "policy"
short_description "Analyze all account usage and determines recommend consolidation or deletion. See the [README](https://github.com/rightscale/policy_templates/tree/master/cost/low_account_usage/) and [docs.rightscale.com/policies](http://docs.rightscale.com/policies/) to learn more."
long_description "Version: 1.0"
severity "low"
category "Cost"

###############################################################################
# Permissions
###############################################################################

###############################################################################
# Parameters
###############################################################################
parameter "param_email" do
  type "list"
  label "Email List"
  description "Email addresses of the recipients you wish to notify"
end

parameter "param_billing_centers" do
  type "list"
  label "Billing Center List"
  description "List of Billing Center names you want to report on.  Leave blank to select all top level Billing Centers."
end

parameter "param_cost_metric" do
  type "string"
  label "Cost Metric"
  allowed_values "Unamortized Unblended","Amortized Unblended","Unamortized Blended","Amortized Blended"
  default "Unamortized Unblended"
  description "Select the cost metric for your report.  See the README file for more details"
end

parameter "param_graph_dimension" do
  type "string"
  label "Graph Dimension"
  allowed_values "Category","Instance Type","Region","Resource Group","Resource Type","Service","Usage Type","Usage Unit","Cloud Vendor","Cloud Vendor Account","Cloud Vendor Account Name"
  default "Category"
  description "Select which dimension you'd like to be broken out on the graph in the report."
end

###############################################################################
# Authentication
###############################################################################

auth "auth_rs", type: "rightscale"

###############################################################################
# Resources
###############################################################################

###############################################################################
# Datasources
###############################################################################

datasource "ds_session" do
  request do
    auth $auth_rs
    verb "GET"
    host rs_cm_host
    path "/api/sessions"
    header "X-Api-Version", "1.5"
    query "view", "whoami"
  end
  result do
    field "userid", join(["/grs/users/",last(split(first(jmes_path(response, "links[?rel == 'user'].href")),'/'))])
  end
end

datasource "ds_current_user_organizations" do
  request do
    run_script $js_current_user_organizations, $ds_session
  end
  result do
    collect jmes_path(response, "orgs") do
      field "href", jmes_path(col_item, "href")
      field "org_id", last(split(jmes_path(col_item, "href"),"/"))
      field "name", jmes_path(col_item, "name")
      field "cluster", jmes_path(col_item, "starts_with(legacy.account_url, 'https://us-3') && '3' || starts_with(legacy.account_url, 'https://us-4') && '4'")
    end
  end
end

datasource "ds_currency_reference" do
  request do
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/master/cost/scheduled_reports/currency_reference.json"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_currency_code" do
  iterate $ds_current_user_organizations
  request do
    auth $auth_rs
    host rs_optima_host
    path join(["/bill-analysis/orgs/",val(iter_item,"org_id"),"/settings/currency_code"])
    header "Api-Version", "0.1"
    header "User-Agent", "RS Policies"
  end
  result do
    encoding "json"
    field "org_id", val(iter_item,"org_id")
    field "org_href", val(iter_item, "href")
    field "org_name", val(iter_item, "name")
    field "id", jmes_path(response,"id")
    field "value", jmes_path(response,"value")
  end
end

datasource "ds_billing_centers" do
  iterate $ds_current_user_organizations
  request do
    auth $auth_rs
    host rs_optima_host
    path join(["/analytics/orgs/",val(iter_item,"org_id"),"/billing_centers"])
    header "Api-Version", "1.0"
    header "User-Agent", "RS Policies"
    query "view", "allocation_table"
  end
  result do
    encoding "json"
    collect jmes_path(response,"[*]") do
      field "org_id", val(iter_item,"org_id")
      field "org_href", val(iter_item, "href")
      field "org_name", val(iter_item, "name")
      field "href", jmes_path(col_item,"href")
      field "id", jmes_path(col_item,"id")
      field "name", jmes_path(col_item,"name")
      field "parent_id", jmes_path(col_item,"parent_id")
      field "ancestor_ids", jmes_path(col_item,"ancestor_ids")
      field "allocation_table", jmes_path(col_item,"allocation_table")
    end
  end
end

###############################################################################
# Scripts
###############################################################################
script "js_current_user_organizations", type: "javascript" do
  parameters "ds_session"
  result "request"
  code <<-EOF
    var request = {
      "auth": "auth_rs",
      "verb": "GET",
      "host": "governance.rightscale.com",
      "path": ds_session["userid"],
      "headers": {"X-Api-Version": "2.0" },
      "query_params":{"view":"extended"}
    }
  EOF
end

###############################################################################
# Policy
###############################################################################

policy "policy_scheduled_report" do
  validate $ds_currency_code do
    summary_template "{{ rs_org_name }} (Org ID: {{ rs_org_id }}): Full Cost Scheduled Report"
    detail_template <<-EOS
  
### For more detailed cost information, visit [Optima](https://analytics.rightscale.com/orgs/{{ rs_org_id }}/dashboard).
  
For more information on this report, please view the [README](https://github.com/rightscale/policy_templates/tree/master/cost/scheduled_reports).
___
###### Policy Applied in Account: {{ rs_project_name }} (Account ID: {{ rs_project_id }}) within Org: {{ rs_org_name }} (Org ID: {{ rs_org_id }})
EOS
    escalate $escalation_send_email
    check eq(0,1)
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "escalation_send_email" do
  email $param_email
end

###############################################################################
# Cloud Workflow
###############################################################################