name "Superseded Instances"
rs_pt_ver 20180301
type "policy"
short_description "This Policy Template is used to identify instance sizes that have been superseded. \n See the [README](https://github.com/flexera-public/policy_templates/tree/master/cost/superseded_instance) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
category "Cost"
severity "low"
default_frequency "daily"
tenancy "single"
info(
  version: "4.0",
  provider: "Flexera Optima",
  service: "Compute",
  policy_set: "",
  recommendation_type: "Usage Reduction"
)

###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  category "Policy Settings"
  label "Email Addresses"
  description "A list of email addresses to notify."
  default []
end

parameter "param_min_savings" do
  type "number"
  category "Policy Settings"
  label "Minimum Savings Threshold"
  description "Minimum potential savings required to generate a recommendation."
  min_value 0
  default 0
end

parameter "param_instance_type" do
  type "string"
  category "Policy Settings"
  label "Instance Type Category"
  description "Instance Type Category to pick from. See README for more information."
  allowed_values "regular", "next_gen", "burstable", "amd"
  default "regular"
end

parameter "param_billing_centers" do
  type "list"
  category "Filters"
  label "Billing Center Names"
  description "List of Billing Center names you want to report on. Leave empty to select all top level Billing Centers."
  default []
end

###############################################################################
# Authentication
###############################################################################

credentials "auth_flexera" do
  schemes "oauth2"
  label "flexera"
  description "Select Flexera One OAuth2 credentials"
  tags "provider=flexera"
end

###############################################################################
# Datasources & Scripts
###############################################################################

# Get applied policy metadata for use later
datasource "ds_applied_policy" do
  request do
    auth $auth_flexera
    host rs_governance_host
    path join(["/api/governance/projects/", rs_project_id, "/applied_policies/", policy_id])
    header "Api-Version", "1.0"
  end
end

datasource "ds_billing_centers" do
  request do
    auth $auth_flexera
    host rs_optima_host
    path join(["/analytics/orgs/", rs_org_id, "/billing_centers"])
    header "Api-Version", "1.0"
    header "User-Agent", "RS Policies"
    query "view", "allocation_table"
    ignore_status [403]
  end
  result do
    encoding "json"
    collect jmes_path(response, "[*]") do
      field "href", jmes_path(col_item, "href")
      field "id", jmes_path(col_item, "id")
      field "name", jmes_path(col_item, "name")
      field "parent_id", jmes_path(col_item, "parent_id")
    end
  end
end

# Gather local currency info
datasource "ds_currency_reference" do
  request do
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/master/cost/scheduled_reports/currency_reference.json"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_currency_code" do
  request do
    auth $auth_flexera
    host rs_optima_host
    path join(["/bill-analysis/orgs/", rs_org_id, "/settings/currency_code"])
    header "Api-Version", "0.1"
    header "User-Agent", "RS Policies"
    ignore_status [403]
  end
  result do
    encoding "json"
    field "id", jmes_path(response, "id")
    field "value", jmes_path(response, "value")
  end
end

datasource "ds_currency_target" do
  run_script $js_currency_target, $ds_currency_reference, $ds_currency_code
end

script "js_currency_target", type:"javascript" do
  parameters "ds_currency_reference", "ds_currency_code"
  result "result"
  code <<-EOS
  // Default to USD if currency is not found
  result = ds_currency_reference['USD']

  if (ds_currency_code['value'] != undefined && ds_currency_reference[ds_currency_code['value']] != undefined) {
    result = ds_currency_reference[ds_currency_code['value']]
  }
EOS
end

# Branching logic:
# This datasource returns an empty array if the target currency is USD.
# This prevents ds_currency_conversion from running if it's not needed.
datasource "ds_conditional_currency_conversion" do
  run_script $js_conditional_currency_conversion, $ds_currency_target
end

script "js_conditional_currency_conversion", type: "javascript" do
  parameters "ds_currency_target"
  result "result"
  code <<-EOS
  result = []
  // Make the request only if the target currency is not USD
  if (ds_currency_target['code'] != 'USD') {
    result = [1]
  }
EOS
end

datasource "ds_currency_conversion" do
  # Only make a request if the target currency is not USD
  iterate $ds_conditional_currency_conversion
  request do
    host "api.xe-auth.flexeraeng.com"
    path "/prod/{proxy+}"
    query "from", "USD"
    query "to", val($ds_currency_target, 'code')
    query "amount", "1"
    # Ignore currency conversion if API has issues
    ignore_status [400, 404, 502]
  end
  result do
    encoding "json"
    field "from", jmes_path(response, "from")
    field "to", jmes_path(response, "to")
    field "amount", jmes_path(response, "amount")
    field "year", jmes_path(response, "year")
  end
end

datasource "ds_currency" do
  run_script $js_currency, $ds_currency_target, $ds_currency_conversion
end

script "js_currency", type:"javascript" do
  parameters "ds_currency_target", "ds_currency_conversion"
  result "result"
  code <<-EOS
  result = ds_currency_target
  result['exchange_rate'] = 1

  if (ds_currency_conversion['to'] != undefined) {
    currency_code = ds_currency_target['code']
    current_month = parseInt(new Date().toISOString().split('-')[1])

    conversion_block = _.find(ds_currency_conversion['to'][currency_code], function(item) {
      return item['month'] == current_month
    })

    if (conversion_block != undefined) {
      result['exchange_rate'] = conversion_block['monthlyAverage']
    }
  }
EOS
end

datasource "ds_optima_dates" do
  run_script $js_optima_dates
end

script "js_optima_dates", type:"javascript" do
  result "result"
  code <<-EOS
  result = [
    { days_back: 0 },
    { days_back: 7 },
    { days_back: 14 },
    { days_back: 21 },
    { days_back: 28 }
  ]
EOS
end

datasource "ds_new_bc_costs" do
  iterate $ds_optima_dates
  request do
    run_script $js_new_bc_costs, val(iter_item, 'days_back'), rs_org_id, $ds_billing_centers, $param_billing_centers, rs_optima_host
  end
  result do
    encoding "json"
    collect jmes_path(response, "rows[*]") do
      field "vendor", jmes_path(col_item, "dimensions.vendor")
      field "vendor_account", jmes_path(col_item, "dimensions.vendor_account")
      field "vendor_account_name", jmes_path(col_item, "dimensions.vendor_account_name")
      field "resource_group", jmes_path(col_item, "dimensions.resource_group")
      field "operating_system", jmes_path(col_item, "dimensions.operating_system")
      field "resource_type", jmes_path(col_item, "dimensions.resource_type")
      field "service", jmes_path(col_item, "dimensions.service")
      field "cost_amortized_unblended_adj", jmes_path(col_item, "metrics.cost_amortized_unblended_adj")
      field "region", jmes_path(col_item, "dimensions.region")
      field "instance_type", jmes_path(col_item, "dimensions.instance_type")
      field "billing_center_id", jmes_path(col_item, "dimensions.billing_center_id")
      field "resource_id", jmes_path(col_item, "dimensions.resource_id")
      field "days_back", val(iter_item, "days_back")
    end
  end
end

script "js_new_bc_costs", type: "javascript" do
  parameters "days_back", "org_id", "ds_billing_centers", "param_billing_centers", "rs_optima_host"
  result "request"
  code <<-EOS
  //Get Start and End dates
  start_date = new Date()
  start_date.setDate(start_date.getDate() - 3 - days_back)
  start_date = start_date.toISOString().split("T")[0]

  end_date = new Date()
  end_date.setDate(end_date.getDate() - 2 - days_back)
  end_date = end_date.toISOString().split("T")[0]

  billing_center_ids = []

  if (param_billing_centers.length === 0) {
    top_billing_centers = _.reject(ds_billing_centers, function(bc){ return bc.parent_id != null });
    billing_center_ids = _.map(top_billing_centers, function(value, key){ return value.id });
  } else {
    // get array of billing center id's that match the names in param_billing_centers.
    billing_center_names = _.map(param_billing_centers, function(name){ return name.toLowerCase(); });
    billing_center_ids = _.compact(_.map(ds_billing_centers, function(value){ if(_.contains(billing_center_names, value.name.toLowerCase())){return value.id} }));
  }

  dimensions = [
    "vendor", "vendor_account", "vendor_account_name",
    "resource_group", "operating_system", "resource_type",
    "service", "region", "instance_type", "billing_center_id",
    "resource_id"
  ]

  azure_service_expression = {
    "type": "or",
    "expressions" : [
      { "dimension": "service", "type": "equal", "value": "Microsoft.Compute" },
      { "dimension": "service", "type": "equal", "value": "microsoft.compute" }
    ]
  }

  expression = [
    {"type" : "and", "expressions" : [
      azure_service_expression,
      {"dimension":"category","type":"equal","value":"Compute"},
      {"dimension":"vendor","type":"equal","value":"Azure"},
      {"dimension":"resource_type","type":"substring","substring":"Virtual Machines"}
    ]},
    {"type" : "and", "expressions" : [
      azure_service_expression,
      {"dimension":"category","type":"equal","value":"Compute"},
      {"dimension":"vendor","type":"equal","value":"AzureCSP"},
      {"dimension":"resource_type","type":"substring","substring":"Virtual Machines"}
    ]},
    {"type" : "and", "expressions" : [
      {"dimension":"category","type":"equal","value":"Compute"},
      {"dimension":"resource_type","type":"equal","value":"Compute Instance"},
      {"dimension":"vendor","type":"equal","value":"AWS"}
    ]},
    {"type" : "and", "expressions" : [
      azure_service_expression,
      {"dimension":"category","type":"equal","value":"Compute"},
      {"dimension":"vendor","type":"equal","value":"AzureMCA-Enterprise"},
      {"dimension":"resource_type","type":"substring","substring":"Virtual Machines"}
    ]},
      {"type" : "and", "expressions" : [
        azure_service_expression,
      {"dimension":"category","type":"equal","value":"Compute"},
      {"dimension":"vendor","type":"equal","value":"AzureMCA-CSP"},
      {"dimension":"resource_type","type":"substring","substring":"Virtual Machines"}
    ]},
    {"type" : "and", "expressions" : [
      {"dimension":"vendor","type":"equal","value":"GCP"},
      {"dimension":"service", "type":"equal", value:"Compute Engine"},
      {"dimension":"resource_type","type":"substring","substring":"*running*"}
    ]},
  ]

  var request = {
    auth: "auth_flexera",
    host: rs_optima_host,
    verb: "POST",
    path: "/bill-analysis/orgs/" + org_id + "/costs/select",
    body_fields: {
      "billing_center_ids": billing_center_ids,
      "dimensions": dimensions,
      "metrics": ["cost_amortized_unblended_adj"],
      "granularity": "day",
      "start_at": start_date,
      "end_at": end_date,
      "limit": 100000,
      "filter": {
        "type": "or",
        "expressions": expression
      }
    },
    headers: {
      "Api-Version": "1.0",
      "User-Agent": "RS Policies",
    }
  }
EOS
end

datasource "ds_aws_region_map" do
  run_script $js_aws_region_map
end

script "js_aws_region_map", type: "javascript" do
  result "result"
  code <<-EOS
  result = {
    "US East (Ohio)": "us-east-2",
    "US East (N. Virginia)": "us-east-1",
    "US West (N. California)": "us-west-1",
    "US West (Oregon)": "us-west-2",
    "Africa (Cape Town)": "af-south-1",
    "Asia Pacific (Hong Kong)": "ap-east-1",
    "Asia Pacific (Hyderabad)": "ap-south-2",
    "Asia Pacific (Jakarta)": "ap-southeast-3",
    "Asia Pacific (Melbourne)": "ap-southeast-4",
    "Asia Pacific (Mumbai)": "ap-south-1",
    "Asia Pacific (Osaka)": "ap-northeast-3",
    "Asia Pacific (Seoul)": "ap-northeast-2",
    "Asia Pacific (Singapore)": "ap-southeast-1",
    "Asia Pacific (Sydney)": "ap-southeast-2",
    "Asia Pacific (Tokyo)": "ap-northeast-1",
    "Canada (Central)": "ca-central-1",
    "Europe (Frankfurt)": "eu-central-1",
    "Europe (Ireland)": "eu-west-1",
    "Europe (London)": "eu-west-2",
    "Europe (Milan)": "eu-south-1",
    "Europe (Paris)": "eu-west-3",
    "Europe (Spain)": "eu-south-2",
    "Europe (Stockholm)": "eu-north-1",
    "Europe (Zurich)": "eu-central-2",
    "Middle East (Bahrain)": "me-south-1",
    "Middle East (UAE)": "me-central-1",
    "South America (São Paulo)": "sa-east-1",
    "South America (Sao Paulo)": "sa-east-1",
    "AWS GovCloud (US-East)": "us-gov-east-1",
    "AWS GovCloud (US-West)": "us-gov-west-1"
  }
EOS
end

datasource "ds_format_costs" do
  run_script $js_format_costs, $ds_new_bc_costs, $ds_billing_centers
end

script "js_format_costs", type: "javascript" do
  parameters "new_bc_costs", "ds_billing_centers"
  result "result"
  code <<-EOS
  bc_object = {}

  _.each(ds_billing_centers, function(bc) {
    bc_object[bc['id']] = bc['name']
  })

  instances = {}

  _.each(new_bc_costs, function(cost) {
    id = cost['resource_id']

    if (instances[id] == undefined) {
      instances[id] = {}
    }

    instances[id]['billing_center'] = bc_object[cost['billing_center_id']]
    instances[id]['id'] = cost['id']
    instances[id]['vendor'] = cost['vendor']
    instances[id]['vendor_account'] = cost['vendor_account']
    instances[id]['vendor_account_name'] = cost['vendor_account_name']
    instances[id]['resource_group'] = cost['resource_group']
    instances[id]['operating_system'] = cost['operating_system']
    instances[id]['resource_type'] = cost['resource_type']
    instances[id]['region'] = cost['region']
    instances[id]['service'] = cost['service']
    instances[id]['resource_id'] = cost['resource_id']

    if (instances[id]['instance_type'] == undefined) {
      instances[id]['instance_type'] = {}
    }

    instances[id]['instance_type'][cost['days_back']] = cost['instance_type']

    if (cost['days_back'] == 0) {
      if (instances[id]['run_rate'] == undefined || instances[id]['run_rate'] == null) {
        instances[id]['run_rate'] = 0
      }

      instances[id]['run_rate'] += cost['cost_amortized_unblended_adj'] * 365.25 / 12
    }
  })

  result = []

  _.each(Object.keys(instances), function(key) {
    result.push(instances[key])
  })
EOS
end

datasource "ds_aws_instance_size_map" do
  request do
    verb "GET"
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/master/data/aws/instance_types.json"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_azure_instance_size_map" do
  request do
    verb "GET"
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/master/data/azure/instance_types.json"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_google_instance_size_map" do
  request do
    verb "GET"
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/master/data/google/instance_types.json"
  end
end

datasource "ds_aws_instance_cost_map" do
  request do
    verb "GET"
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/master/data/aws/aws_ec2_pricing.json"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_azure_instance_cost_map" do
  request do
    verb "GET"
    host "raw.githubusercontent.com"
    path "/rightscale/policy_templates/master/data/azure/azure_vm_pricing.json"
    header "User-Agent", "RS Policies"
  end
end

datasource "ds_combined_instance_data" do
  run_script $js_combined_instance_data, $ds_format_costs, $ds_aws_instance_size_map, $ds_azure_instance_size_map, $ds_google_instance_size_map, $ds_aws_instance_cost_map, $ds_azure_instance_cost_map, $ds_aws_region_map, $param_instance_type, $ds_applied_policy, $ds_currency, $ds_currency_conversion, $param_min_savings
end

script "js_combined_instance_data", type: "javascript" do
  parameters "ds_format_costs", "ds_aws_instance_size_map", "ds_azure_instance_size_map", "ds_google_instance_size_map", "ds_aws_instance_cost_map", "ds_azure_instance_cost_map", "ds_aws_region_map", "param_instance_type", "ds_applied_policy", "ds_currency", "ds_currency_conversion", "param_min_savings"
  result "result"
  code <<-'EOS'
  var result = []
  var superseded_instance_map = _.extend(ds_aws_instance_size_map, ds_azure_instance_size_map, ds_google_instance_size_map)
  var cost_map = { "AWS": ds_aws_instance_cost_map, "Azure": ds_azure_instance_cost_map }

  total_savings = 0

  // for loop instead of _.each() so that continue statements function as expected
  for (var i = 0; i < ds_format_costs.length; i++) {
    instance = ds_format_costs[i]

    vendor = instance['vendor']
    region = instance['region']
    operating_system = instance['operating_system']
    instance_type = instance['instance_type'][0]
    instance_type_new = instance['instance_type'][0]
    instance_type_old = instance['instance_type'][28]

    if (instance_type_old == null || instance_type_old == undefined) {
      instance_type_old = instance['instance_type'][21]
    }

    if (instance_type_old == null || instance_type_old == undefined) {
      instance_type_old = instance['instance_type'][14]
    }

    if (instance_type_old == null || instance_type_old == undefined) {
      instance_type_old = instance['instance_type'][7]
    }

    if (instance_type == "None" || instance_type == undefined || instance_type == null) {
      continue
    }

    if (vendor == "AWS") {
      region_code = ds_aws_region_map[region]
    } else {
      region_code = region
    }

    var found_instance_type = superseded_instance_map[instance_type]

    if (typeof(found_instance_type) === "undefined" || found_instance_type == null) {
      instance["new_instance_type"] = "Unavailable"
      if (param_min_savings == 0) {
        result.push(instance)
      }
    } else {
      var superseded = found_instance_type["superseded"]
      if (typeof(superseded) === "undefined" || superseded == null) {
        continue
      } else {
        var new_instance_type = superseded[param_instance_type]

        if (new_instance_type === "undefined" || new_instance_type == null || new_instance_type == "") { continue; }

        var new_instance_type_info = superseded_instance_map[new_instance_type]
        if ( new_instance_type_info === "undefined" ) { continue }
        old_instance_ena = found_instance_type.enhanced_networking || false
        new_instance_ena = new_instance_type_info.enhanced_networking || false
        old_instance_vpc = !found_instance_type.ec2_classic || false
        new_instance_vpc = !new_instance_type_info.ec2_classic || false

        if (!old_instance_ena && new_instance_ena) {
          var ena_incompatible = "true"
        } else {
          var ena_incompatible = "false"
        }

        if ((!old_instance_vpc) && (new_instance_vpc)) {
          var vpc_incompatible_move = "true"
        } else {
          var vpc_incompatible_move = "false"
        }

        old_list_price = null
        new_list_price = null
        estimated_monthly_savings = null

        if (cost_map[vendor] != undefined) {
          if (cost_map[vendor][region_code] != undefined) {
            if (cost_map[vendor][region_code][instance_type] != undefined) {
              if (cost_map[vendor][region_code][instance_type][operating_system] != undefined) {
                old_list_price = cost_map[vendor][region_code][instance_type][operating_system]["pricePerUnit"] * 24 * 30
              }
            }

            if (cost_map[vendor][region_code][new_instance_type] != undefined) {
              if (cost_map[vendor][region_code][new_instance_type][operating_system] != undefined) {
                new_list_price = cost_map[vendor][region_code][new_instance_type][operating_system]["pricePerUnit"] * 24 * 30
              }
            }
          }
        }

        if (old_list_price != null && new_list_price != null) {
          estimated_monthly_savings = old_list_price - new_list_price

          if (estimated_monthly_savings <= 0) {
            estimated_monthly_savings = null
          }
        }

        if (estimated_monthly_savings != null) {
          total_savings += estimated_monthly_savings
        }

        old_list_price *= ds_currency['exchange_rate']
        new_list_price *= ds_currency['exchange_rate']
        estimated_monthly_savings *= ds_currency['exchange_rate']

        instance_size_changed = instance_type_old != null && instance_type_old != undefined && instance_type_new != null && instance_type_new != undefined && instance_type_new != instance_type_old

        if ((estimated_monthly_savings != null && estimated_monthly_savings >= param_min_savings) || param_min_savings == 0) {
          result.push({
            billing_center: instance['billing_center'],
            vendor: vendor,
            accountID: instance['vendor_account'],
            accountName: instance['vendor_account_name'],
            resourceGroup: instance['resource_group'],
            service: instance['service'],
            region: region_code,
            operating_system: operating_system,
            instance_type: instance_type,
            new_instance_type: new_instance_type,
            instance_size_changed: instance_size_changed,
            resourceID: instance['resource_id'],
            resourceType: instance['resource_type'],
            run_rate: instance['run_rate'],
            vpc_incompatible_move: vpc_incompatible_move,
            ena_incompatible: ena_incompatible,
            old_price: parseFloat(old_list_price.toFixed(3)),
            new_price: parseFloat(new_list_price.toFixed(3)),
            savings: parseFloat(estimated_monthly_savings.toFixed(3)),
            savingsCurrency: ds_currency['symbol'],
            policy_name: ds_applied_policy['name'],
            message: ""
          })
        }
      }
    }
  }

  // Dummy entry to ensure the check statement in validation always runs at least once
  result.push({
    billing_center: "",       vendor: "",                   accountID: "",
    accountName: "",          resourceGroup: "",            service: "",
    region: "",               operating_system: "",         instance_type: "",
    new_instance_type: "",    instance_size_changed: "",    resourceID: "",
    resourceType: "",         run_rate: "",                 vpc_incompatible_move: "",
    ena_incompatible: "",     old_price: "",                new_price: "",
    savings: "",              savingsCurrency: "",          policy_name: "",
    message: ""
  })

  api_disclaimer = ""

  if (ds_currency_conversion['to'] == undefined && ds_currency['code'] != 'USD') {
    api_disclaimer = "\n\nSavings values are in USD due to a malfunction with Flexera's internal currency conversion API. Please contact Flexera support to report this issue."
  }

  result[0]['message'] = "Total Potential Savings: " + ds_currency['code'] + total_savings.toFixed(2) + api_disclaimer
EOS
end

###############################################################################
# Policy
###############################################################################

policy "pol_superseded_instance" do
  validate_each $ds_combined_instance_data do
    summary_template "{{ with index data 0 }}{{ .policy_name }}{{ end }}: {{ len data }} Potentially Superseded Instances Found"
    detail_template "{{ with index data 0 }}{{ .message }}{{ end }}"
    check eq(val(item, "resourceID"), "")
    escalate $esc_email
    hash_exclude "run_rate", "old_price", "new_price", "savings", "savingsCurrency", "policy_name", "message"
    export do
      resource_level false
      field "vendor" do
        label "Cloud Vendor"
      end
      field "accountID" do
        label "Account Id"
      end
      field "accountName" do
        label "Account Name"
      end
      field "resourceGroup" do
        label "Resource Group"
      end
      field "region" do
        label "Region"
      end
      field "service" do
        label "Service"
      end
      field "operating_system" do
        label "OS"
      end
      field "resourceID" do
        label "Resource ID"
      end
      field "resourceType" do
        label "Resource Type"
      end
      field "billing_center" do
        label "Billing Center"
      end
      field "instance_type" do
        label "Current Instance Type"
      end
      field "new_instance_type" do
        label "New Instance Type"
      end
      field "instance_size_changed" do
        label "Instance Resized in Last 30 Days"
      end
      field "vpc_incompatible_move" do
        label "VPC Required"
      end
      field "ena_incompatible" do
        label "ENA Required"
      end
      field "run_rate" do
        label "Current Monthly Estimated Cost"
      end
      field "old_price" do
        label "Current Monthly List Price"
      end
      field "new_price" do
        label "New Monthly List Price"
      end
      field "savings" do
        label "Estimated Monthly Savings"
      end
      field "savingsCurrency" do
        label "Savings Currency"
      end
      field "id" do
        label "ID"
        path "resourceID"
      end
    end
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "esc_email" do
  automatic true
  label "Send Email"
  description "Send incident email"
  email $param_email
end
