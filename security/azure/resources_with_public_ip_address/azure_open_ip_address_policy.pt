name "Open Resources with public IP"
rs_pt_ver 20180301
type "policy"
short_description "Get the Resource Group or any resources with public IP address. See the [docs.rightscale.com/policies](https://docs.rightscale.com/policies/) to learn more."
long_description ""
severity "low"
category "Security"
info(
  version: "2.0",
  provider: "Azure",
  service: "compute",
  policy_set: ""
)


###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  label "Email addresses of the recipients you wish to notify"
end


###############################################################################
# Authentication
###############################################################################

#authenticate with Azure
credentials "azure_auth" do
  schemes "oauth2"
  label "Azure"
  description "Select the Azure Resource Manager Credential from the list."
  tags "provider=azure_rm"
end


###############################################################################
# Pagination
###############################################################################

pagination "azure_pagination" do
  get_page_marker do
    body_path "nextLink"
  end
  set_page_marker do
    uri true
  end
end


###############################################################################
# Datasources
###############################################################################

#get all subscription details.
datasource "ds_subscriptions" do
  request do
    auth $azure_auth
    pagination $azure_pagination
    host "management.azure.com"
    path "/subscriptions/"
    query "api-version","2019-06-01"
    header "User-Agent", "RS Policies"
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "subscriptionId", jmes_path(col_item,"subscriptionId")
      field "displayName", jmes_path(col_item,"displayName")
      field "state", jmes_path(col_item,"state")
    end
  end
end

datasource "ds_azure_resources" do
  iterate $ds_subscriptions
  request do
    auth $azure_auth
    pagination $azure_pagination
    host "management.azure.com"
    path join(["/subscriptions/", val(iter_item,"subscriptionId"),"/providers/Microsoft.Network/publicIPAddresses"])
    query "api-version","2020-07-01"
    header "User-Agent", "RS Policies"
    ignore_status [404]
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "id", jmes_path(col_item,"id")
      field "region", jmes_path(col_item,"location")
      field "name", jmes_path(col_item,"name")
      field "state", jmes_path(col_item, "properties.provisioningState")
      field "ipAddressType", jmes_path(col_item, "properties.publicIPAddressVersion")
      field "publicIPAllocationMethod", jmes_path(col_item, "properties.publicIPAllocationMethod")
      field "publicIPAddress", jmes_path(col_item, "properties.ipAddress")
    end
  end
end

datasource "ds_filter_azure_resources" do
  run_script $js_filter_azure_resources, $ds_azure_resources
end


###############################################################################
# Scripts
###############################################################################

script "js_filter_azure_resources", type: "javascript" do
  result "res"
  parameters "ds_azure_resources"
  code <<-EOS
  var res = [];
  _.each(ds_azure_resources, function(ds_azure_resource){
    if(ds_azure_resource.publicIPAddress != null){
      res.push(ds_azure_resource);
    }       
  })
  EOS
end


###############################################################################
# Policy
###############################################################################

policy "policy_azure_resource" do
  validate $ds_filter_azure_resources do
    summary_template "{{ rs_project_name }} (Account ID: {{ rs_project_id }}): {{ len data }} rows containing Azure Resources with Public Ip address."
    escalate $escalate_email
    check eq(0,1)
    export do
      resource_level true
      field "publicIPAddress" do
        label "IP Address"
      end
      field "ipAddressType" do
        label "IP Address Type"
      end
      field "id" do
        label "Azure Resource Id"
      end
      field "publicIPAllocationMethod" do
        label "IP Address Allocation Method"
      end
      field "name" do
        label "Resource Name"
      end
      field "region" do
        label "Region"
      end
    end
  end
end


###############################################################################
# Escalations
###############################################################################

escalation "escalate_email" do
  email $param_email
end
