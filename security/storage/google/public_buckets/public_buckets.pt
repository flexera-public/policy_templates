name "Google Open Buckets Policy"
rs_pt_ver 20180301
type "policy"
short_description "Checks for buckets that are open to everyone"
long_description "Version 1.0"
severity "high"
category "Security"

permission "perm_read_creds" do
  actions   "rs_cm.show_sensitive","rs_cm.index_sensitive"
  resources "rs_cm.credentials"
end

parameter "param_escalate_to" do
  type "string"
  label "Email address to send escalation emails to"
  default "rshade@rightscale.com"
end

parameter "param_google_project" do
  type "string"
  label "Google Cloud Project"
  allowed_pattern /^[0-9a-z:\.-]+$/
  default "rightscale:services1"
end

auth "auth_google", type: "oauth2" do
  token_url "https://www.googleapis.com/oauth2/v4/token"
  grant type: "jwt_bearer" do
    iss cred("GCE_PLUGIN_ACCOUNT")
    aud "https://www.googleapis.com/oauth2/v4/token"
    additional_claims do {
      "scope" => "https://www.googleapis.com/auth/devstorage.full_control"
    } end
    signing_key cred("GCE_PLUGIN_PRIVATE_KEY")
  end
end

pagination "google_pagination" do
  get_page_marker do
    body_path "{{nextPageToken}}"
  end
  set_page_marker do
    query "pageToken"
  end
end

datasource "ds_storage_buckets" do
  request do
    auth $auth_google
    host "www.googleapis.com"
    path "/storage/v1/b"
    query "projection", "full"
    query "project", $param_google_project
  end
  result do
    encoding "json"
    collect jmes_path(response, "value[*]") do
      field "name", jmes_path(col_item, "name")
      field "acl" do
        collect jmes_path(col_item, "acl") do
          field "entity", jmes_path(col_item, "entity")
          field "role", jmes_path(col_item, "role")
        end
      end
    end
  end
end

escalation "alert" do
   email $escalate_to
end

policy "public_buckets" do
  validate_each $ds_storage_buckets do
    summary_template "Public Buckets Found in Google"
    detail_template <<-EOS
# Public Buckets Found in Google
| Bucket Name | Entity | Role |
| ----------- | ------ | ---- |
{{ range data -}}
| {{.name}} | {{.entity}} | {{.role}} |
{{ end -}}
EOS
    escalate $alert
    check gt(0,0)
    #check logic_not(contains(val(item, "grantee_uris"), "http://acs.amazonaws.com/groups/global/AllUsers"))
  end
end
