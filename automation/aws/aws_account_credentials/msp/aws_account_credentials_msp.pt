name "MSP Report: AWS Account Credentials"
rs_pt_ver 20180301
type "policy"
short_description "Consolidates reports for the AWS Account Credentials policy template from child organizations. See the [README](https://github.com/flexera-public/policy_templates/tree/master/automation/aws/aws_account_credentials/msp/) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
category "Cost"
severity "low"
default_frequency "daily"
info(
  version: "0.1.0",
  provider: "AWS",
  service: "IAM",
  policy_set: "Authentication",
  publish: "false"
)

###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  category "Policy Settings"
  label "Email Addresses"
  description "Email addresses of the recipients you wish to notify when new incidents are created"
  default []
end

parameter "param_status" do
  type "list"
  category "Policy Settings"
  label "Status Filter"
  description "Only credentials whose status is specified here will be reported. Select all three options to report all credentials regardless of status."
  allowed_values [ "Passed", "Failed", "Unknown" ]
  default [ "Failed" ]
end

###############################################################################
# Authentication
###############################################################################

credentials "auth_flexera" do
  schemes "oauth2"
  label "Flexera"
  description "Select Flexera One OAuth2 credentials"
  tags "provider=flexera"
end

###############################################################################
# Datasources & Scripts
###############################################################################

# Get applied policy metadata for use later
datasource "ds_applied_policy" do
  request do
    auth $auth_flexera
    host rs_governance_host
    path join(["/api/governance/projects/", rs_project_id, "/applied_policies/", policy_id])
    header "Api-Version", "1.0"
  end
end

# Get region-specific Flexera API endpoints
datasource "ds_flexera_api_hosts" do
  run_script $js_flexera_api_hosts, rs_optima_host
end

script "js_flexera_api_hosts", type: "javascript" do
  parameters "rs_optima_host"
  result "result"
  code <<-EOS
  host_table = {
    "api.optima.flexeraeng.com": {
      flexera: "api.flexera.com",
      fsm: "api.fsm.flexeraeng.com",
      grs: "grs-front.iam-us-east-1.flexeraeng.com"
    },
    "api.optima-eu.flexeraeng.com": {
      flexera: "api.flexera.eu",
      fsm: "api.fsm-eu.flexeraeng.com",
      grs: "grs-front.eu-central-1.iam-eu.flexeraeng.com"
    },
    "api.optima-apac.flexeraeng.com": {
      flexera: "api.flexera.au",
      fsm: "api.fsm-apac.flexeraeng.com",
      grs: "grs-front.ap-southeast-2.iam-apac.flexeraeng.com"
    }
  }

  result = host_table[rs_optima_host]
EOS
end

datasource "ds_msp_customers" do
  request do
    auth $auth_flexera
    host val($ds_flexera_api_hosts, "flexera")
    path join(["/msp/v1/orgs/", rs_org_id, "/customers"])
    header "User-Agent", "RS Policies"
  end
  result do
    encoding "json"
    collect jmes_path(response, "[*]") do
      field "id", jmes_path(col_item, "id")
      field "name", jmes_path(col_item, "name")
      field "kind", jmes_path(col_item, "kind")
      field "createdAt", jmes_path(col_item, "createdAt")
      field "updatedAt", jmes_path(col_item, "updatedAt")
    end
  end
end

datasource "ds_child_projects" do
  iterate $ds_msp_customers
  request do
    auth $auth_flexera
    host val($ds_flexera_api_hosts, "grs")
    path join(["/grs/orgs/", val(iter_item, "id"), "/projects"])
    header "X-Api-Version", "2.0"
    header "User-Agent", "RS Policies"
  end
  result do
    encoding "json"
    collect jmes_path(response, "[*]") do
      field "projectId", jmes_path(col_item, "id")
      field "orgId", val(iter_item, "id")
    end
  end
end

datasource "ds_incidents" do
  iterate $ds_child_projects
  request do
    auth $auth_flexera
    host rs_governance_host
    path join(["/api/governance/projects/", val(iter_item, "projectId"), "/incidents"])
    header "User-Agent", "RS Policies"
    header "Api-Version", "1.0"
    query "state", "triggered"
  end
  result do
    encoding "json"
    collect jmes_path(response, "items[*]") do
      field "incident_id", jmes_path(col_item, "id")
      field "applied_policy_id", jmes_path(col_item, "applied_policy.id")
      field "summary", jmes_path(col_item, "summary")
      field "state", jmes_path(col_item, "state")
      field "orgId", val(iter_item, "orgId")
      field "projectId", val(iter_item, "projectId")
    end
  end
end

datasource "ds_incidents_creds_passed" do
  run_script $js_incidents_filtered, $ds_incidents, "Passed"
end

datasource "ds_incidents_creds_failed" do
  run_script $js_incidents_filtered, $ds_incidents, "Failed"
end

datasource "ds_incidents_creds_unknown" do
  run_script $js_incidents_filtered, $ds_incidents, "Unknown"
end

script "js_incidents_filtered", type: "javascript" do
  parameters "ds_incidents", "type"
  result "result"
  code <<-EOS
  setting_map = {
    "Passed": "AWS Account Credentials Passed:",
    "Failed": "AWS Account Credentials Failed:",
    "Unknown": "AWS Account Credentials Unknown:"
  }

  incidents = _.filter(ds_incidents, function(incident) {
    return incident["summary"].indexOf(setting_map[type]) != -1
  })

  result = _.map(incidents, function(incident) {
    return {
      incident_id: incident["incident_id"],
      applied_policy_id: incident["applied_policy_id"],
      summary: incident["summary"],
      state: incident["state"],
      orgId: incident["orgId"],
      projectId: incident["projectId"],
      type: type
    }
  })
EOS
end

datasource "ds_incidents_combined" do
  run_script $js_incidents_combined, $ds_incidents_creds_passed, $ds_incidents_creds_failed, $ds_incidents_creds_unknown
end

script "js_incidents_combined", type: "javascript" do
  parameters "ds_incidents_creds_passed", "ds_incidents_creds_failed", "ds_incidents_creds_unknown"
  result "result"
  code <<-EOS
  result = ds_incidents_creds_passed.concat(ds_incidents_creds_failed, ds_incidents_creds_unknown)
EOS
end

datasource "ds_incidents_with_details" do
  iterate $ds_incidents_combined
  request do
    auth $auth_flexera
    host rs_governance_host
    path join(["/api/governance/projects/", val(iter_item, "projectId"), "/incidents/", val(iter_item, "incident_id")])
    query "view", "extended"
    header "User-Agent", "RS Policies"
    header "Api-Version", "1.0"
  end
  result do
    encoding "json"
    field "data", jmes_path(response, "violation_data")
    field "incident_id", val(iter_item, "incident_id")
    field "applied_policy_id", val(iter_item, "applied_policy_id")
    field "summary", val(iter_item, "summary")
    field "state", val(iter_item, "state")
    field "orgId", val(iter_item, "orgId")
    field "projectId", val(iter_item, "projectId")
    field "type", val(iter_item, "type")
  end
end

datasource "ds_credential_statuses" do
  run_script $js_credential_statuses, $ds_incidents_with_details, $param_status
end

script "js_credential_statuses", type: "javascript" do
  parameters "ds_incidents_with_details", "param_status"
  result "result"
  code <<-EOS
  cleaned = _.map(ds_incidents_with_details, function(incident) {
    return {
      orgID: incident["data"]["orgId"],
      orgName: incident["data"]["orgName"],
      id: incident["data"]["id"],
      name: incident["data"]["name"],
      status: incident["data"]["status"],
      type: incident["type"]
    }
  })

  result = _.filter(cleaned, function(incident) { return _.contains(param_status, incident["type"]) })
EOS
end

###############################################################################
# Policy
###############################################################################

policy "pol_credentials" do
  validate_each $ds_credential_statuses do
    summary_template "{{ with index data 0 }}{{ .policy_name }}{{ end }}: {{ len data }} AWS Account Credentials"
    check eq(val(item, "id"), "")
    escalate $esc_email
    export do
      resource_level true
      field "orgId" do
        label "Flexera Org ID"
      end
      field "orgName" do
        label "Flexera Org Name"
      end
      field "id" do
        label "Account ID"
      end
      field "name" do
        label "Account Name"
      end
      field "status" do
        label "Status"
      end
    end
  end
end

###############################################################################
# Escalations
###############################################################################

escalation "esc_email" do
  automatic true
  label "Send Email"
  description "Send incident email"
  email $param_email
end
