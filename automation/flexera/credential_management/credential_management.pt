name "Flexera Automation Credential Management"
rs_pt_ver 20180301
type "policy"
short_description "Reports any credentials that are going to expire soon. Also reports any credentials outside of the user-specified allow list and, optionally, deletes them. See the [README](https://github.com/flexera-public/policy_templates/tree/master/automation/flexera/credential_management) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
severity "low"
category "Operational"
default_frequency "weekly"
info(
  version: "0.1",
  provider: "Flexera",
  service: "Automation",
  policy_set: "Automation"
)

###############################################################################
# Parameters
###############################################################################

parameter "param_email" do
  type "list"
  category "Policy Settings"
  label "Email Addresses"
  description "A list of email addresses to notify."
  default []
end

parameter "param_cred_expiration_days" do
  type "number"
  category "Policy Settings"
  label "Days Until Expiration"
  description "The number of days before expiration to report on an expiring credential. Set to 0 to only report on already-expired credentials."
  default 90
  min_value 0
end

parameter "param_cred_allow_list" do
  type "list"
  category "Filters"
  label "Credential Allow List"
  description "A list of allowed credential names or IDs. All other credentials will be reported on. Leave blank to not report on disallowed credentials."
  default []
end

parameter "param_automatic_action" do
  type "list"
  category "Actions"
  label "Automatic Actions"
  description "When this value is set, this policy will automatically take the selected action(s)"
  default []
  allowed_values ["Delete Disallowed Credentials"]
end

###############################################################################
# Authentication
###############################################################################

credentials "auth_flexera" do
  schemes "oauth2"
  label "Flexera"
  description "Select Flexera One OAuth2 credentials"
  tags "provider=flexera"
end

###############################################################################
# Datasources & Scripts
###############################################################################

datasource "ds_applied_policy" do
  request do
    auth $auth_flexera
    host rs_governance_host
    path join(["/api/governance/projects/", rs_project_id, "/applied_policies/", policy_id])
    header "Api-Version", "1.0"
  end
end

# Get API endpoint for automation credentials API
datasource "ds_flexera_cloud_host" do
  run_script $js_flexera_cloud_host, rs_governance_host
end

script "js_flexera_cloud_host", type: "javascript" do
  parameters "rs_governance_host"
  result "result"
  code <<-'EOS'
  host_table = {
    "governance-3.rightscale.com": { cloud: "cloud-3.rightscale.com" },
    "governance-4.rightscale.com": { cloud: "cloud-4.rightscale.com" }
  }

  result = host_table[rs_governance_host]

  if (result == undefined) { result = host_table["governance-3.rightscale.com"] }
EOS
end

datasource "ds_credentials" do
  request do
    auth $auth_flexera
    host val(ds_flexera_cloud_host, 'cloud')
    path join(["/cloud/projects/", rs_project_id, "/credentials"])
    header "Api-Version", "1.0"
  end
  result do
    encoding "json"
    collect jmes_path(response, "items[*]") do
      field "created_at", jmes_path(col_item, "created_at")
      field "created_by", jmes_path(col_item, "created_by.email")
      field "description", jmes_path(col_item, "description")
      field "id", jmes_path(col_item, "id")
      field "kind", jmes_path(col_item, "kind")
      field "name", jmes_path(col_item, "name")
      field "plugin_match", jmes_path(col_item, "plugin_match")
      field "project_id", jmes_path(col_item, "project_id")
      field "scheme", jmes_path(col_item, "scheme")
      field "signer_id", jmes_path(col_item, "signer_id")
      field "tags", jmes_path(col_item, "tags")
      field "updated_at", jmes_path(col_item, "updated_at")
      field "updated_by", jmes_path(col_item, "updated_by.email")
    end
  end
end

datasource "ds_disallowed_credentials" do
  run_script $js_disallowed_credentials, $ds_credentials, $param_cred_allow_list
end

script "js_disallowed_credentials", type: "javascript" do
  parameters "ds_credentials", "param_cred_allow_list"
  result "result"
  code <<-'EOS'
  result = []

  if (param_cred_allow_list.length > 0) {
    result = _.reject(ds_credentials, function(cred) {
      return _.contains(param_cred_allow_list, cred['name']) || _.contains(param_cred_allow_list, cred['id'])
    })
  }
EOS
end

datasource "ds_allowed_credentials" do
  run_script $js_allowed_credentials, $ds_credentials, $param_cred_allow_list
end

script "js_allowed_credentials", type: "javascript" do
  parameters "ds_credentials", "param_cred_allow_list"
  result "result"
  code <<-'EOS'
  if (param_cred_allow_list.length > 0) {
    result = _.filter(ds_credentials, function(cred) {
      return _.contains(param_cred_allow_list, cred['name']) || _.contains(param_cred_allow_list, cred['id'])
    })
  } else {
    result = ds_credentials
  }
EOS
end

datasource "ds_expiring_credentials" do
  run_script $js_expiring_credentials, $ds_allowed_credentials, $param_cred_expiration_days
end

script "js_expiring_credentials", type: "javascript" do
  parameters "ds_allowed_credentials", "param_cred_expiration_days"
  result "result"
  code <<-'EOS'
  result = []

  _.each(ds_allowed_credentials, function(cred) {

  })
EOS
end
